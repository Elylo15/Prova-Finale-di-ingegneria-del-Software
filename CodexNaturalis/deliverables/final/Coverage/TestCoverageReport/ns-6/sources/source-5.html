


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=windows-1252"> 
  <title>Coverage Report > GamePageController</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">it.polimi.ingsw.client.view.gui.controller</a>
</div>

<h1>Coverage Summary for Class: GamePageController (it.polimi.ingsw.client.view.gui.controller)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">GamePageController</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/101)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/564)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/938)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package it.polimi.ingsw.client.view.gui.controller;
&nbsp;
&nbsp;import it.polimi.ingsw.client.view.gui.SceneManager;
&nbsp;import it.polimi.ingsw.client.view.gui.Utilities;
&nbsp;import it.polimi.ingsw.client.view.gui.message.GUIMessages;
&nbsp;import it.polimi.ingsw.messages.currentStateMessage;
&nbsp;import it.polimi.ingsw.messages.endGameState.declareWinnerMessage;
&nbsp;import it.polimi.ingsw.messages.playerTurnState.updatePlayerMessage;
&nbsp;import it.polimi.ingsw.messages.responseMessage;
&nbsp;import it.polimi.ingsw.model.CommonArea;
&nbsp;import it.polimi.ingsw.model.Player;
&nbsp;import it.polimi.ingsw.model.PlayerArea;
&nbsp;import it.polimi.ingsw.model.cards.*;
&nbsp;import javafx.animation.FadeTransition;
&nbsp;import javafx.animation.KeyFrame;
&nbsp;import javafx.animation.PauseTransition;
&nbsp;import javafx.animation.Timeline;
&nbsp;import javafx.application.Platform;
&nbsp;import javafx.event.EventHandler;
&nbsp;import javafx.fxml.FXML;
&nbsp;import javafx.fxml.Initializable;
&nbsp;import javafx.geometry.Pos;
&nbsp;import javafx.scene.Node;
&nbsp;import javafx.scene.control.Label;
&nbsp;import javafx.scene.image.Image;
&nbsp;import javafx.scene.image.ImageView;
&nbsp;import javafx.scene.input.MouseEvent;
&nbsp;import javafx.scene.layout.Pane;
&nbsp;import javafx.scene.media.Media;
&nbsp;import javafx.scene.media.MediaPlayer;
&nbsp;import javafx.scene.paint.Color;
&nbsp;import javafx.scene.text.Font;
&nbsp;import javafx.util.Duration;
&nbsp;
&nbsp;import java.net.URL;
&nbsp;import java.util.*;
&nbsp;import java.util.concurrent.*;
&nbsp;import java.util.concurrent.atomic.AtomicBoolean;
&nbsp;import java.util.concurrent.atomic.AtomicInteger;
&nbsp;import java.util.stream.Collectors;
&nbsp;
&nbsp;import static it.polimi.ingsw.client.view.gui.Utilities.*;
&nbsp;
&nbsp;/**
&nbsp; * This class is a controller for the gui scene where the game is played.
&nbsp; * It contains the game board and the player&#39;s cards, objectives, and resources.
&nbsp; * It displays the game state and the player&#39;s turn.
&nbsp; * When the player&#39;s turn is active, it allows the player to interact with the game board.
&nbsp; */
<b class="nc">&nbsp;public class GamePageController implements Initializable {</b>
<b class="nc">&nbsp;    private final double offsetPions = 5;</b>
<b class="nc">&nbsp;    private final double[][] positions = {</b>
&nbsp;            {1668, 468},
&nbsp;            {1726, 468}, {1784, 468},
&nbsp;            {1812, 415}, {1755, 415}, {1697, 415}, {1639, 415},
&nbsp;            {1639, 362}, {1697, 362}, {1755, 362}, {1812, 362},
&nbsp;            {1812, 311}, {1755, 311}, {1697, 311}, {1639, 311},
&nbsp;            {1639, 256}, {1697, 256}, {1755, 256}, {1812, 256},
&nbsp;            {1812, 204}, {1726, 175}, {1639, 204},
&nbsp;            {1639, 150}, {1639, 96},
&nbsp;            {1673, 53}, {1726, 45}, {1781, 53},
&nbsp;            {1812, 150}, {1812, 96},
&nbsp;            {1726, 108}
&nbsp;    };
<b class="nc">&nbsp;    private final double offsetAreaX = 156;</b>
<b class="nc">&nbsp;    private final double offsetAreaY = 79;</b>
<b class="nc">&nbsp;    private final double layoutPlacedStarterX = 678;</b>
<b class="nc">&nbsp;    private final double layoutPlacedStarterY = 203;</b>
<b class="nc">&nbsp;    private final double fitHeightPlaced = 133;</b>
<b class="nc">&nbsp;    private final double fitWidthPlaced = 200;</b>
<b class="nc">&nbsp;    private final double fitHeightCommon = 141;</b>
<b class="nc">&nbsp;    private final double fitWidthCommon = 208;</b>
<b class="nc">&nbsp;    private final double fitHeightCard = 157;</b>
<b class="nc">&nbsp;    private final double fitWidthCard = 234;</b>
<b class="nc">&nbsp;    private final double layoutYResource = 746;</b>
<b class="nc">&nbsp;    private final double layoutXPick0 = 364;</b>
<b class="nc">&nbsp;    private final double layoutXPick1 = 587;</b>
<b class="nc">&nbsp;    private final double layoutYGold = 895;</b>
<b class="nc">&nbsp;    private final double layoutXDeck = 56;</b>
<b class="nc">&nbsp;    private final double layoutYObjMy = 606;</b>
<b class="nc">&nbsp;    private final double layoutYObj0 = 750;</b>
<b class="nc">&nbsp;    private final double layoutYObj1 = 894;</b>
<b class="nc">&nbsp;    private final double layoutXObjective = 1659;</b>
<b class="nc">&nbsp;    private final double layoutXChoiceObjective1 = 949;</b>
<b class="nc">&nbsp;    private final double layoutXChoiceObjective2 = 1279;</b>
<b class="nc">&nbsp;    private final double layoutYHand = 814;</b>
<b class="nc">&nbsp;    private final double layoutXCard0 = 864;</b>
<b class="nc">&nbsp;    private final double layoutXCard1 = 1110;</b>
<b class="nc">&nbsp;    private final double layoutXCard2 = 1356;</b>
<b class="nc">&nbsp;    private final Label winnerLabel = new Label();</b>
<b class="nc">&nbsp;    private final ArrayList&lt;Label&gt; playerInfoLabel = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;    private final BlockingQueue&lt;Object&gt; messageQueue = new LinkedBlockingQueue&lt;&gt;();</b>
<b class="nc">&nbsp;    private final ArrayList&lt;Player&gt; players = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;    private final ArrayList&lt;ObjectiveCard&gt; objectivesToChose = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;    private final int[] selectedToPlace = new int[4];</b>
<b class="nc">&nbsp;    private double layoutXSaved = 0;</b>
&nbsp;    @FXML
&nbsp;    private ImageView online;
&nbsp;    @FXML
&nbsp;    private ImageView rotate;
&nbsp;    @FXML
&nbsp;    private Label player1;
&nbsp;    @FXML
&nbsp;    private Label player2;
&nbsp;    @FXML
&nbsp;    private Label player3;
&nbsp;    @FXML
&nbsp;    private Label player4;
&nbsp;    @FXML
&nbsp;    private Pane mainPane;
&nbsp;    @FXML
&nbsp;    private Label playerName;
&nbsp;    @FXML
&nbsp;    private Pane playground;
&nbsp;    @FXML
&nbsp;    private ImageView state;
&nbsp;    @FXML
&nbsp;    private ImageView onTop;
&nbsp;    @FXML
&nbsp;    private ImageView nextPlayer;
&nbsp;    @FXML
&nbsp;    private ImageView colorName;
&nbsp;    private ImageView winner;
<b class="nc">&nbsp;    private ImageView red = null;</b>
<b class="nc">&nbsp;    private ImageView blue = null;</b>
<b class="nc">&nbsp;    private ImageView purple = null;</b>
<b class="nc">&nbsp;    private ImageView green = null;</b>
&nbsp;    private ImageView back;
&nbsp;    private ImageView selectedCard;
&nbsp;    private Player myself;
&nbsp;    private PlayerHand myHand;
&nbsp;    private ObjectiveCard myObjective;
&nbsp;    private PlayerArea myPlayerArea;
&nbsp;    private String currentPlayerNickname;
&nbsp;    private CommonArea commonArea;
&nbsp;    private ArrayList&lt;ObjectiveCard&gt; commonObjectives;
&nbsp;    private String currentState;
<b class="nc">&nbsp;    private int clickCounter = -1;</b>
<b class="nc">&nbsp;    private boolean isLastTurn = false;</b>
&nbsp;    private int selectedStarterFront;
&nbsp;    private int selectedPick;
&nbsp;    private int selectedObjective;
&nbsp;    private currentStateMessage currentStateMessageSaved;
<b class="nc">&nbsp;    private boolean wrong = false;</b>
<b class="nc">&nbsp;    private boolean first = true;</b>
&nbsp;    private boolean isUpdate;
<b class="nc">&nbsp;    private final AtomicBoolean endgame = new AtomicBoolean(false);</b>
&nbsp;
&nbsp;    // References to Threads
<b class="nc">&nbsp;    ThreadPoolExecutor executor = new ThreadPoolExecutor(10, 10, 200, TimeUnit.MILLISECONDS, new LinkedBlockingQueue&lt;&gt;());</b>
&nbsp;    Future&lt;Void&gt; messageListener;
&nbsp;    Future&lt;Void&gt; messageProcessor;
&nbsp;
&nbsp;
&nbsp;
&nbsp;
&nbsp;    /**
&nbsp;     * It is used to initialize the controller, it starts the message listener and processor threads.
&nbsp;     *
&nbsp;     * @param url            not used
&nbsp;     * @param resourceBundle not used
&nbsp;     */
&nbsp;    @Override
&nbsp;    public void initialize(URL url, ResourceBundle resourceBundle) {
<b class="nc">&nbsp;        rotateEffect(rotate, 2);</b>
<b class="nc">&nbsp;        startMessageListener();</b>
<b class="nc">&nbsp;        startMessageProcessor();</b>
<b class="nc">&nbsp;        playerName.setFont(Font.loadFont(getClass().getResourceAsStream(&quot;/Fonts/FantasyScript.ttf&quot;), 54));</b>
<b class="nc">&nbsp;        Font font = Font.loadFont(getClass().getResourceAsStream(&quot;/Fonts/FantasyScript.ttf&quot;), 43);</b>
<b class="nc">&nbsp;        player1.setFont(font);</b>
<b class="nc">&nbsp;        player2.setFont(font);</b>
<b class="nc">&nbsp;        player3.setFont(font);</b>
<b class="nc">&nbsp;        player4.setFont(font);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Starts a new internal thread to listen for messages
&nbsp;     */
&nbsp;    private void startMessageListener() {
<b class="nc">&nbsp;        messageListener = executor.submit(() -&gt; {</b>
<b class="nc">&nbsp;            while (!endgame.get()) {</b>
&nbsp;                try {
<b class="nc">&nbsp;                    Object message = GUIMessages.readToGUI();</b>
<b class="nc">&nbsp;                    if (message != null) {</b>
<b class="nc">&nbsp;                        messageQueue.put(message);</b>
&nbsp;
&nbsp;                    }
<b class="nc">&nbsp;                } catch (Exception ignore) {</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            return null;</b>
&nbsp;        });
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Starts a new internal thread to process messages
&nbsp;     */
&nbsp;    private void startMessageProcessor() {
<b class="nc">&nbsp;        messageProcessor = executor.submit(() -&gt; {</b>
<b class="nc">&nbsp;            while (!endgame.get()) {</b>
&nbsp;                try {
<b class="nc">&nbsp;                    Object message = messageQueue.take();</b>
&nbsp;
<b class="nc">&nbsp;                    Platform.runLater(() -&gt; processMessage(message));</b>
<b class="nc">&nbsp;                } catch (Exception ignore) {</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            return null;</b>
&nbsp;        });
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Processes the message received from the server based on its type.
&nbsp;     * Displays text and shows popups or images based on the message received.
&nbsp;     *
&nbsp;     * @param message the message to process
&nbsp;     */
&nbsp;    private void processMessage(Object message) {
<b class="nc">&nbsp;        switch (message) {</b>
<b class="nc">&nbsp;            case currentStateMessage currentStateMessage -&gt; {</b>
<b class="nc">&nbsp;                currentStateMessageSaved = currentStateMessage;</b>
<b class="nc">&nbsp;                caseCurrentStateMessage(currentStateMessageSaved);</b>
&nbsp;            }
<b class="nc">&nbsp;            case ArrayList&lt;?&gt; objects -&gt; handleObjectiveMessage(objects);</b>
<b class="nc">&nbsp;            case updatePlayerMessage updatePlayerMessage -&gt; updatePlayerCase(updatePlayerMessage);</b>
<b class="nc">&nbsp;            case responseMessage responseMessage -&gt; handleResponseMessage(responseMessage);</b>
<b class="nc">&nbsp;            case declareWinnerMessage declareWinnerMessage -&gt; displayWinner(declareWinnerMessage);</b>
<b class="nc">&nbsp;            case String disconnected -&gt; {</b>
<b class="nc">&nbsp;                if (Objects.equals(disconnected, &quot;disconnected&quot;)) {</b>
<b class="nc">&nbsp;                    endgame.set(true);</b>
<b class="nc">&nbsp;                    messageListener.cancel(true);</b>
<b class="nc">&nbsp;                    messageProcessor.cancel(true);</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            default -&gt; System.out.println(&quot;Unknown message received&quot;);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void handleObjectiveMessage(ArrayList&lt;?&gt; list) {
<b class="nc">&nbsp;        if (Objects.equals(currentState, &quot;objectiveState&quot;) &amp;&amp; !list.isEmpty() &amp;&amp; list.get(0) instanceof ObjectiveCard) {</b>
<b class="nc">&nbsp;            playSoundEffect(&quot;/Audio/you.mp3&quot;);</b>
<b class="nc">&nbsp;            objectivesToChose.add((ObjectiveCard) list.get(0));</b>
<b class="nc">&nbsp;            objectivesToChose.add((ObjectiveCard) list.get(1));</b>
<b class="nc">&nbsp;            objectiveCase();</b>
<b class="nc">&nbsp;            setState(currentStateMessageSaved.getPlayer().getColor());</b>
<b class="nc">&nbsp;            choosePopUp(currentStateMessageSaved.getPlayer().getColor());</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Handles the responseMessage received from the server
&nbsp;     * Displays a pop-up indicating the player to retry if the response is incorrect
&nbsp;     *
&nbsp;     * @param responseMessage the responseMessage received from the server
&nbsp;     */
&nbsp;    private void handleResponseMessage(responseMessage responseMessage) {
<b class="nc">&nbsp;        if (!responseMessage.getCorrect()) {</b>
<b class="nc">&nbsp;            wrong = true;</b>
<b class="nc">&nbsp;            wrongPopUp(currentStateMessageSaved.getPlayer().getColor());</b>
<b class="nc">&nbsp;            playSoundEffect(&quot;/Audio/wrong.mp3&quot;);</b>
<b class="nc">&nbsp;            caseCurrentStateMessage(currentStateMessageSaved);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Displays the winner of the game
&nbsp;     *
&nbsp;     * @param declareWinnerMessage the message containing the winner
&nbsp;     */
&nbsp;    private void displayWinner(declareWinnerMessage declareWinnerMessage) {
<b class="nc">&nbsp;        rotate.onMouseClickedProperty().setValue(null);</b>
<b class="nc">&nbsp;        rotate.addEventHandler(MouseEvent.MOUSE_CLICKED, this::hideSeeWinner);</b>
<b class="nc">&nbsp;        winner(declareWinnerMessage);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Displays or hides the winner, and player info
&nbsp;     */
&nbsp;    private void hideSeeWinner(MouseEvent event) {
<b class="nc">&nbsp;        if (winner.getOpacity() == 1.0) {</b>
<b class="nc">&nbsp;            Utilities.fadeOutTransition(mainPane, winner, 1, false);</b>
<b class="nc">&nbsp;            Utilities.fadeOutTransition(mainPane, winnerLabel, 0.8, false);</b>
<b class="nc">&nbsp;            Utilities.fadeOutTransition(mainPane, back, 1.0, false);</b>
<b class="nc">&nbsp;            for (Label label : playerInfoLabel) Utilities.fadeOutTransition(mainPane, label, 0.8, false);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            Utilities.fadeInTransition(winner, 1);</b>
<b class="nc">&nbsp;            Utilities.fadeInTransition(winnerLabel, 0.8);</b>
<b class="nc">&nbsp;            Utilities.fadeInTransition(back, 1.0);</b>
<b class="nc">&nbsp;            for (Label label : playerInfoLabel) Utilities.fadeInTransition(label, 0.8);</b>
&nbsp;
<b class="nc">&nbsp;            winner.toFront();</b>
<b class="nc">&nbsp;            winnerLabel.toFront();</b>
<b class="nc">&nbsp;            for (Label label : playerInfoLabel) label.toFront();</b>
<b class="nc">&nbsp;            back.toFront();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Displays the winner of the game and the player info
&nbsp;     *
&nbsp;     * @param message the message containing the winner
&nbsp;     */
&nbsp;    private void winner(declareWinnerMessage message) {
<b class="nc">&nbsp;        HashMap&lt;String, Integer&gt; objectives = message.getNumberOfObjects();</b>
<b class="nc">&nbsp;        HashMap&lt;String, Integer&gt; scores = message.getPlayersPoints();</b>
&nbsp;
<b class="nc">&nbsp;        List&lt;String&gt; winners = getWinners(objectives, scores);</b>
&nbsp;
<b class="nc">&nbsp;        Platform.runLater(() -&gt; {</b>
<b class="nc">&nbsp;            if (winners.size() == 1) {</b>
<b class="nc">&nbsp;                String color = Objects.requireNonNull(findPlayerByName(winners.getFirst())).getColor();</b>
&nbsp;
<b class="nc">&nbsp;                if (Objects.equals(color, &quot;red&quot;))</b>
<b class="nc">&nbsp;                    winner = new ImageView(new Image(Objects.requireNonNull(getClass().getResourceAsStream(&quot;/Images/Winner/winRed.png&quot;))));</b>
<b class="nc">&nbsp;                else if (Objects.equals(color, &quot;blue&quot;))</b>
<b class="nc">&nbsp;                    winner = new ImageView(new Image(Objects.requireNonNull(getClass().getResourceAsStream(&quot;/Images/Winner/winBlue.png&quot;))));</b>
<b class="nc">&nbsp;                else if (Objects.equals(color, &quot;green&quot;))</b>
<b class="nc">&nbsp;                    winner = new ImageView(new Image(Objects.requireNonNull(getClass().getResourceAsStream(&quot;/Images/Winner/winGreen.png&quot;))));</b>
<b class="nc">&nbsp;                else if (Objects.equals(color, &quot;purple&quot;))</b>
<b class="nc">&nbsp;                    winner = new ImageView(new Image(Objects.requireNonNull(getClass().getResourceAsStream(&quot;/Images/Winner/winPur.png&quot;))));</b>
&nbsp;
<b class="nc">&nbsp;                winnerLabel.setText(winners.getFirst());</b>
&nbsp;            } else {
<b class="nc">&nbsp;                winner.setImage(new Image(Objects.requireNonNull(getClass().getResourceAsStream(&quot;/Images/Winner/winTwo.png&quot;))));</b>
<b class="nc">&nbsp;                winnerLabel.setText(winners.getFirst() + &quot;\n&quot; + winners.get(1));</b>
&nbsp;            }
<b class="nc">&nbsp;            mainPane.getChildren().add(winner);</b>
<b class="nc">&nbsp;            Utilities.fadeInTransition(winner, 1.0);</b>
&nbsp;
&nbsp;
<b class="nc">&nbsp;            winnerLabel.setFont(Font.loadFont(getClass().getResourceAsStream(&quot;/Fonts/FantasyScript.ttf&quot;), 60));</b>
<b class="nc">&nbsp;            winnerLabel.setTextFill(Color.rgb(53, 31, 23));</b>
<b class="nc">&nbsp;            winnerLabel.setLayoutX(980);</b>
<b class="nc">&nbsp;            winnerLabel.setLayoutY(555);</b>
<b class="nc">&nbsp;            winnerLabel.setPrefWidth(440);</b>
<b class="nc">&nbsp;            winnerLabel.setPrefHeight(120);</b>
<b class="nc">&nbsp;            winnerLabel.setAlignment(Pos.CENTER);</b>
<b class="nc">&nbsp;            mainPane.getChildren().add(winnerLabel);</b>
<b class="nc">&nbsp;            Utilities.fadeInTransition(winnerLabel, 0.8);</b>
<b class="nc">&nbsp;            displayPlayerInfo(scores, objectives);</b>
&nbsp;
<b class="nc">&nbsp;            back = new ImageView(new Image(Objects.requireNonNull(getClass().getResourceAsStream(&quot;/Images/Buttons/image.png&quot;))));</b>
<b class="nc">&nbsp;            back.setOnMouseClicked(event -&gt; GUIMessages.writeToClient(true));</b>
<b class="nc">&nbsp;            back.setFitWidth(500);</b>
<b class="nc">&nbsp;            back.setFitHeight(131);</b>
<b class="nc">&nbsp;            back.setLayoutX(1038);</b>
<b class="nc">&nbsp;            back.setLayoutY(882);</b>
<b class="nc">&nbsp;            mainPane.getChildren().add(back);</b>
<b class="nc">&nbsp;            Utilities.fadeInTransition(back, 1.0);</b>
<b class="nc">&nbsp;            hooverEffect(back, 1.05);</b>
<b class="nc">&nbsp;            if (winners.contains(myself.getNickname()))</b>
<b class="nc">&nbsp;                playSoundEffect(&quot;/Audio/win.mp3&quot;);</b>
&nbsp;            else
<b class="nc">&nbsp;                playSoundEffect(&quot;/Audio/lose.mp3&quot;);</b>
&nbsp;        });
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Returns the winners of the game
&nbsp;     *
&nbsp;     * @param objectives the objectives of the players
&nbsp;     * @param scores     the scores of the players
&nbsp;     * @return the list of winners
&nbsp;     */
&nbsp;    private List&lt;String&gt; getWinners(HashMap&lt;String, Integer&gt; objectives, HashMap&lt;String, Integer&gt; scores) {
<b class="nc">&nbsp;        List&lt;String&gt; winners = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        int highestScore = Integer.MIN_VALUE;</b>
<b class="nc">&nbsp;        int mostObjectives = Integer.MIN_VALUE;</b>
&nbsp;
&nbsp;        // First pass to determine the highest score and most objectives
<b class="nc">&nbsp;        for (Map.Entry&lt;String, Integer&gt; entry : scores.entrySet()) {</b>
<b class="nc">&nbsp;            String player = entry.getKey();</b>
<b class="nc">&nbsp;            int score = entry.getValue();</b>
<b class="nc">&nbsp;            int playerObjectives = objectives.getOrDefault(player, 0);</b>
&nbsp;
<b class="nc">&nbsp;            if (score &gt; highestScore || (score == highestScore &amp;&amp; playerObjectives &gt; mostObjectives)) {</b>
<b class="nc">&nbsp;                highestScore = score;</b>
<b class="nc">&nbsp;                mostObjectives = playerObjectives;</b>
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        // Second pass to collect all players with the highest score and most objectives
<b class="nc">&nbsp;        for (Map.Entry&lt;String, Integer&gt; entry : scores.entrySet()) {</b>
<b class="nc">&nbsp;            String player = entry.getKey();</b>
<b class="nc">&nbsp;            int score = entry.getValue();</b>
<b class="nc">&nbsp;            int playerObjectives = objectives.getOrDefault(player, 0);</b>
&nbsp;
<b class="nc">&nbsp;            if (score == highestScore &amp;&amp; playerObjectives == mostObjectives) {</b>
<b class="nc">&nbsp;                winners.add(player);</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return winners;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Displays the player information
&nbsp;     *
&nbsp;     * @param scores     the scores of the players
&nbsp;     * @param objectives the objectives of the players
&nbsp;     */
&nbsp;    private void displayPlayerInfo(HashMap&lt;String, Integer&gt; scores, HashMap&lt;String, Integer&gt; objectives) {
<b class="nc">&nbsp;        int i = 0;</b>
<b class="nc">&nbsp;        for (Map.Entry&lt;String, Integer&gt; entry : scores.entrySet()) {</b>
<b class="nc">&nbsp;            String playerName = entry.getKey();</b>
<b class="nc">&nbsp;            Integer playerScore = entry.getValue();</b>
<b class="nc">&nbsp;            Integer playerObjectives = objectives.get(playerName);</b>
&nbsp;
&nbsp;            // Label with the player information
<b class="nc">&nbsp;            Label playerInfo = new Label(playerName + &quot; - &quot; + playerScore + &quot; Points - &quot; + playerObjectives + &quot; Objectives&quot;);</b>
&nbsp;
<b class="nc">&nbsp;            playerInfo.setFont(Font.loadFont(getClass().getResourceAsStream(&quot;/Fonts/FantasyScript.ttf&quot;), 37));</b>
<b class="nc">&nbsp;            playerInfo.setTextFill(Color.rgb(53, 31, 23));</b>
<b class="nc">&nbsp;            playerInfo.setLayoutX(497);</b>
<b class="nc">&nbsp;            playerInfo.setLayoutY(198 + 79 * i);</b>
<b class="nc">&nbsp;            playerInfo.setPrefWidth(916);</b>
<b class="nc">&nbsp;            playerInfo.setPrefHeight(75);</b>
<b class="nc">&nbsp;            playerInfo.setAlignment(Pos.CENTER);</b>
&nbsp;
<b class="nc">&nbsp;            playerInfoLabel.add(playerInfo);</b>
<b class="nc">&nbsp;            mainPane.getChildren().add(playerInfoLabel.get(i));</b>
<b class="nc">&nbsp;            Utilities.fadeInTransition(playerInfoLabel.get(i), 0.8);</b>
&nbsp;
<b class="nc">&nbsp;            playerInfoLabel.get(i).toFront();</b>
<b class="nc">&nbsp;            i++;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Finds a player by its nickname
&nbsp;     *
&nbsp;     * @param name the nickname of the player
&nbsp;     * @return the player with the given nickname
&nbsp;     */
&nbsp;    private Player findPlayerByName(String name) {
<b class="nc">&nbsp;        players.add(myself);</b>
&nbsp;
<b class="nc">&nbsp;        for (Player player : players) {</b>
<b class="nc">&nbsp;            if (player.getNickname().equalsIgnoreCase(name)) {</b>
<b class="nc">&nbsp;                return player;</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return null;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Processes the currentStateMessage received from the server
&nbsp;     * Displays the information about the current state of the game and the player&#39;s turn
&nbsp;     *
&nbsp;     * @param currentStateMessage the currentStateMessage received from the server
&nbsp;     */
&nbsp;    private void caseCurrentStateMessage(currentStateMessage currentStateMessage) {
<b class="nc">&nbsp;        isUpdate = false;</b>
<b class="nc">&nbsp;        this.currentState = currentStateMessage.getStateName();</b>
<b class="nc">&nbsp;        isLastTurn = currentStateMessage.isLastTurn();</b>
<b class="nc">&nbsp;        currentStateCase(currentStateMessage);</b>
<b class="nc">&nbsp;        setRotate(currentStateMessage.getPlayer().getColor());</b>
&nbsp;
&nbsp;
<b class="nc">&nbsp;        if (currentStateMessage.getCurrentPlayer().getNickname().equals(myself.getNickname())) {</b>
<b class="nc">&nbsp;            if (Objects.equals(currentState, &quot;StarterCardState&quot;)) {</b>
<b class="nc">&nbsp;                String audioFile = Objects.requireNonNull(SceneManager.class.getResource(&quot;/Audio/you.mp3&quot;)).toString();</b>
<b class="nc">&nbsp;                Media media = new Media(audioFile);</b>
<b class="nc">&nbsp;                MediaPlayer mediaPlayer = new MediaPlayer(media);</b>
<b class="nc">&nbsp;                mediaPlayer.play();</b>
<b class="nc">&nbsp;                setState(currentStateMessage.getPlayer().getColor());</b>
<b class="nc">&nbsp;                starterCase();</b>
<b class="nc">&nbsp;                choosePopUp(currentStateMessage.getPlayer().getColor());</b>
<b class="nc">&nbsp;            } else if (Objects.equals(currentState, &quot;PlaceTurnState&quot;) || Objects.equals(currentState, &quot;PickTurnState&quot;)) {</b>
<b class="nc">&nbsp;                if (isLastTurn)</b>
<b class="nc">&nbsp;                    setLastTurn(currentStateMessage.getCurrentPlayer().getColor());</b>
&nbsp;                else
<b class="nc">&nbsp;                    setState(currentStateMessage.getPlayer().getColor());</b>
<b class="nc">&nbsp;                if (!wrong)</b>
<b class="nc">&nbsp;                    playSoundEffect(&quot;/Audio/you.mp3&quot;);</b>
&nbsp;            }
&nbsp;        } else {
<b class="nc">&nbsp;            if (isLastTurn)</b>
<b class="nc">&nbsp;                setLastTurn(currentStateMessage.getCurrentPlayer().getColor());</b>
&nbsp;            else
<b class="nc">&nbsp;                setStateNotPlaying(currentStateMessage.getCurrentPlayer().getColor());</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Displays the correct image for player&#39;s turn based on the color of the player
&nbsp;     *
&nbsp;     * @param color the color of the player
&nbsp;     */
&nbsp;    private void setState(String color) {
<b class="nc">&nbsp;        ImageView newStateImage = new ImageView();</b>
&nbsp;
<b class="nc">&nbsp;        switch (color) {</b>
&nbsp;            case &quot;red&quot; -&gt;
<b class="nc">&nbsp;                    newStateImage.setImage(new Image(Objects.requireNonNull(getClass().getResourceAsStream(&quot;/Images/YourTurn/youRed.png&quot;))));</b>
&nbsp;            case &quot;blue&quot; -&gt;
<b class="nc">&nbsp;                    newStateImage.setImage(new Image(Objects.requireNonNull(getClass().getResourceAsStream(&quot;/Images/YourTurn/youBlue.png&quot;))));</b>
&nbsp;            case &quot;green&quot; -&gt;
<b class="nc">&nbsp;                    newStateImage.setImage(new Image(Objects.requireNonNull(getClass().getResourceAsStream(&quot;/Images/YourTurn/youGreen.png&quot;))));</b>
&nbsp;            case &quot;purple&quot; -&gt;
<b class="nc">&nbsp;                    newStateImage.setImage(new Image(Objects.requireNonNull(getClass().getResourceAsStream(&quot;/Images/YourTurn/youPur.png&quot;))));</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        state = setNewImage(state, newStateImage);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Displays the correct color for the rotating circle based on the color of the player
&nbsp;     *
&nbsp;     * @param color the color of the player
&nbsp;     */
&nbsp;    private void setRotate(String color) {
<b class="nc">&nbsp;        ImageView newStateImage = new ImageView();</b>
<b class="nc">&nbsp;        switch (color) {</b>
&nbsp;            case &quot;red&quot; -&gt;
<b class="nc">&nbsp;                    rotate.setImage(new Image(Objects.requireNonNull(getClass().getResourceAsStream(&quot;/Images/NameTemplate/red.png&quot;))));</b>
&nbsp;            case &quot;blue&quot; -&gt;
<b class="nc">&nbsp;                    rotate.setImage(new Image(Objects.requireNonNull(getClass().getResourceAsStream(&quot;/Images/NameTemplate/blue.png&quot;))));</b>
&nbsp;            case &quot;green&quot; -&gt;
<b class="nc">&nbsp;                    rotate.setImage(new Image(Objects.requireNonNull(getClass().getResourceAsStream(&quot;/Images/NameTemplate/green.png&quot;))));</b>
&nbsp;            case &quot;purple&quot; -&gt;
<b class="nc">&nbsp;                    rotate.setImage(new Image(Objects.requireNonNull(getClass().getResourceAsStream(&quot;/Images/NameTemplate/purple.png&quot;))));</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        state = setNewImage(state, newStateImage);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Displays the correct image for player&#39;s turn based on the color of the player
&nbsp;     *
&nbsp;     * @param color the color of the player
&nbsp;     */
&nbsp;    private void setStateNotPlaying(String color) {
<b class="nc">&nbsp;        ImageView newStateImage = new ImageView();</b>
&nbsp;
<b class="nc">&nbsp;        if (Objects.equals(currentState, &quot;StarterCardState&quot;) || Objects.equals(currentState, &quot;objectiveState&quot;)) {</b>
<b class="nc">&nbsp;            switch (color) {</b>
&nbsp;                case &quot;red&quot; -&gt;
<b class="nc">&nbsp;                        newStateImage.setImage(new Image(Objects.requireNonNull(getClass().getResourceAsStream(&quot;/Images/Choosing/choosingRed.png&quot;))));</b>
&nbsp;                case &quot;blue&quot; -&gt;
<b class="nc">&nbsp;                        newStateImage.setImage(new Image(Objects.requireNonNull(getClass().getResourceAsStream(&quot;/Images/Choosing/choosingBlue.png&quot;))));</b>
&nbsp;                case &quot;green&quot; -&gt;
<b class="nc">&nbsp;                        newStateImage.setImage(new Image(Objects.requireNonNull(getClass().getResourceAsStream(&quot;/Images/Choosing/choosingGreen.png&quot;))));</b>
&nbsp;                case &quot;purple&quot; -&gt;
<b class="nc">&nbsp;                        newStateImage.setImage(new Image(Objects.requireNonNull(getClass().getResourceAsStream(&quot;/Images/Choosing/choosingPur.png&quot;))));</b>
&nbsp;            }
&nbsp;        } else {
<b class="nc">&nbsp;            switch (color) {</b>
&nbsp;                case &quot;red&quot; -&gt;
<b class="nc">&nbsp;                        newStateImage.setImage(new Image(Objects.requireNonNull(getClass().getResourceAsStream(&quot;/Images/IsPlaying/redPlaying.png&quot;))));</b>
&nbsp;                case &quot;blue&quot; -&gt;
<b class="nc">&nbsp;                        newStateImage.setImage(new Image(Objects.requireNonNull(getClass().getResourceAsStream(&quot;/Images/IsPlaying/bluePlaying.png&quot;))));</b>
&nbsp;                case &quot;green&quot; -&gt;
<b class="nc">&nbsp;                        newStateImage.setImage(new Image(Objects.requireNonNull(getClass().getResourceAsStream(&quot;/Images/IsPlaying/greenPlaying.png&quot;))));</b>
&nbsp;                case &quot;purple&quot; -&gt;
<b class="nc">&nbsp;                        newStateImage.setImage(new Image(Objects.requireNonNull(getClass().getResourceAsStream(&quot;/Images/IsPlaying/purPlaying.png&quot;))));</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        state = setNewImage(state, newStateImage);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Displays the correct image for last turn based on the color of the player
&nbsp;     *
&nbsp;     * @param color the color of the player
&nbsp;     */
&nbsp;    private void setLastTurn(String color) {
<b class="nc">&nbsp;        ImageView newStateImage = new ImageView();</b>
&nbsp;
<b class="nc">&nbsp;        switch (color) {</b>
&nbsp;            case &quot;red&quot; -&gt;
<b class="nc">&nbsp;                    newStateImage.setImage(new Image(Objects.requireNonNull(getClass().getResourceAsStream(&quot;/Images/LastTurn/lastRed.png&quot;))));</b>
&nbsp;            case &quot;blue&quot; -&gt;
<b class="nc">&nbsp;                    newStateImage.setImage(new Image(Objects.requireNonNull(getClass().getResourceAsStream(&quot;/Images/LastTurn/lastBlue.png&quot;))));</b>
&nbsp;            case &quot;green&quot; -&gt;
<b class="nc">&nbsp;                    newStateImage.setImage(new Image(Objects.requireNonNull(getClass().getResourceAsStream(&quot;/Images/LastTurn/lastGreen.png&quot;))));</b>
&nbsp;            case &quot;purple&quot; -&gt;
<b class="nc">&nbsp;                    newStateImage.setImage(new Image(Objects.requireNonNull(getClass().getResourceAsStream(&quot;/Images/LastTurn/lastPur.png&quot;))));</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        state = setNewImage(state, newStateImage);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Displays the correct image for next player button based on the color of the player
&nbsp;     *
&nbsp;     * @param color the color of the player
&nbsp;     */
&nbsp;    private void setNextButton(String color) {
<b class="nc">&nbsp;        switch (color) {</b>
&nbsp;            case &quot;red&quot; -&gt;
<b class="nc">&nbsp;                    nextPlayer.setImage(new Image(Objects.requireNonNull(getClass().getResourceAsStream(&quot;/Images/NextButton/nextRed.png&quot;))));</b>
&nbsp;            case &quot;blue&quot; -&gt;
<b class="nc">&nbsp;                    nextPlayer.setImage(new Image(Objects.requireNonNull(getClass().getResourceAsStream(&quot;/Images/NextButton/nextBlue.png&quot;))));</b>
&nbsp;            case &quot;green&quot; -&gt;
<b class="nc">&nbsp;                    nextPlayer.setImage(new Image(Objects.requireNonNull(getClass().getResourceAsStream(&quot;/Images/NextButton/nextGreen.png&quot;))));</b>
&nbsp;            case &quot;purple&quot; -&gt;
<b class="nc">&nbsp;                    nextPlayer.setImage(new Image(Objects.requireNonNull(getClass().getResourceAsStream(&quot;/Images/NextButton/nextPur.png&quot;))));</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Displays the correct template for the player&#39;s name based on the color of the player
&nbsp;     *
&nbsp;     * @param color the color of the player
&nbsp;     */
&nbsp;    private void setColorName(String color) {
<b class="nc">&nbsp;        ImageView newColor = new ImageView();</b>
&nbsp;
<b class="nc">&nbsp;        switch (color) {</b>
&nbsp;            case &quot;red&quot; -&gt;
<b class="nc">&nbsp;                    newColor.setImage(new Image(Objects.requireNonNull(getClass().getResourceAsStream(&quot;/Images/NameTemplate/redName.png&quot;))));</b>
&nbsp;            case &quot;blue&quot; -&gt;
<b class="nc">&nbsp;                    newColor.setImage(new Image(Objects.requireNonNull(getClass().getResourceAsStream(&quot;/Images/NameTemplate/blueName.png&quot;))));</b>
&nbsp;            case &quot;green&quot; -&gt;
<b class="nc">&nbsp;                    newColor.setImage(new Image(Objects.requireNonNull(getClass().getResourceAsStream(&quot;/Images/NameTemplate/greenName.png&quot;))));</b>
&nbsp;            case &quot;purple&quot; -&gt;
<b class="nc">&nbsp;                    newColor.setImage(new Image(Objects.requireNonNull(getClass().getResourceAsStream(&quot;/Images/NameTemplate/purpleName.png&quot;))));</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        colorName = setNewImage(colorName, newColor);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Displays the correct image for the player using a fade in/fade out transition
&nbsp;     *
&nbsp;     * @param oldImage the old image to fade out
&nbsp;     * @param newImage the new image to fade in
&nbsp;     */
&nbsp;    private ImageView setNewImage(ImageView oldImage, ImageView newImage) {
<b class="nc">&nbsp;        if (oldImage != null) {</b>
<b class="nc">&nbsp;            newImage.setLayoutX(oldImage.getLayoutX());</b>
<b class="nc">&nbsp;            newImage.setLayoutY(oldImage.getLayoutY());</b>
<b class="nc">&nbsp;            newImage.setFitHeight(oldImage.getFitHeight());</b>
<b class="nc">&nbsp;            newImage.setFitWidth(oldImage.getFitWidth());</b>
<b class="nc">&nbsp;            newImage.setPreserveRatio(oldImage.isPreserveRatio());</b>
&nbsp;
<b class="nc">&nbsp;            Utilities.fadeOutTransition(mainPane, oldImage, 1.0, true);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        mainPane.getChildren().add(newImage);</b>
<b class="nc">&nbsp;        Utilities.fadeInTransition(newImage, 1.0);</b>
<b class="nc">&nbsp;        return newImage;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Displays the correct image pop-up indicating the player to wait based on the color of the player
&nbsp;     *
&nbsp;     * @param color the color of the player
&nbsp;     */
&nbsp;    private void waitPopUp(String color) {
<b class="nc">&nbsp;        switch (color) {</b>
<b class="nc">&nbsp;            case &quot;red&quot; -&gt; Utilities.showImagePopup(&quot;/Images/PleaseWait/waitRed.png&quot;, mainPane);</b>
<b class="nc">&nbsp;            case &quot;blue&quot; -&gt; Utilities.showImagePopup(&quot;/Images/PleaseWait/waitBlue.png&quot;, mainPane);</b>
<b class="nc">&nbsp;            case &quot;green&quot; -&gt; Utilities.showImagePopup(&quot;/Images/PleaseWait/waitGreen.png&quot;, mainPane);</b>
<b class="nc">&nbsp;            case &quot;purple&quot; -&gt; Utilities.showImagePopup(&quot;/Images/PleaseWait/waitPur.png&quot;, mainPane);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Displays the correct image pop-up indicating the player to choose based on the color of the player
&nbsp;     *
&nbsp;     * @param color the color of the player
&nbsp;     */
&nbsp;    private void choosePopUp(String color) {
<b class="nc">&nbsp;        switch (color) {</b>
<b class="nc">&nbsp;            case &quot;red&quot; -&gt; Utilities.showImagePopup(&quot;/Images/YouChoose/youChoRe.png&quot;, mainPane);</b>
<b class="nc">&nbsp;            case &quot;blue&quot; -&gt; Utilities.showImagePopup(&quot;/Images/YouChoose/youChoBl.png&quot;, mainPane);</b>
<b class="nc">&nbsp;            case &quot;green&quot; -&gt; Utilities.showImagePopup(&quot;/Images/YouChoose/youChoGr.png&quot;, mainPane);</b>
<b class="nc">&nbsp;            case &quot;purple&quot; -&gt; Utilities.showImagePopup(&quot;/Images/YouChoose/youChoPu.png&quot;, mainPane);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Displays the correct image pop-up indicating the player to retry based on the color of the player
&nbsp;     *
&nbsp;     * @param color the color of the player
&nbsp;     */
&nbsp;    private void wrongPopUp(String color) {
<b class="nc">&nbsp;        switch (color) {</b>
<b class="nc">&nbsp;            case &quot;red&quot; -&gt; Utilities.showImagePopup(&quot;/Images/TryAgain/retryRed.png&quot;, mainPane);</b>
<b class="nc">&nbsp;            case &quot;blue&quot; -&gt; Utilities.showImagePopup(&quot;/Images/TryAgain/retryBlue.png&quot;, mainPane);</b>
<b class="nc">&nbsp;            case &quot;green&quot; -&gt; Utilities.showImagePopup(&quot;/Images/TryAgain/retryGreen.png&quot;, mainPane);</b>
<b class="nc">&nbsp;            case &quot;purple&quot; -&gt; Utilities.showImagePopup(&quot;/Images/TryAgain/retryPur.png&quot;, mainPane);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Sets the page with the information received
&nbsp;     * Displays the pions of the player, and of the current player (if they are not the same)
&nbsp;     *
&nbsp;     * @param message currentStateMessage received from the server
&nbsp;     */
&nbsp;    private void currentStateCase(currentStateMessage message) {
<b class="nc">&nbsp;        this.myself = message.getPlayer();</b>
<b class="nc">&nbsp;        this.commonArea = message.getPlayer().getCommonArea();</b>
<b class="nc">&nbsp;        this.commonObjectives = message.getCommonObjectiveCards();</b>
<b class="nc">&nbsp;        this.myHand = message.getPlayer().getPlayerHand();</b>
<b class="nc">&nbsp;        this.myObjective = message.getPlayer().getObjective();</b>
<b class="nc">&nbsp;        this.myPlayerArea = message.getPlayer().getPlayerArea();</b>
&nbsp;
<b class="nc">&nbsp;        Player currentPlayer = message.getCurrentPlayer();</b>
<b class="nc">&nbsp;        currentPlayerNickname = currentPlayer.getNickname();</b>
<b class="nc">&nbsp;        if (!Objects.equals(myself.getNickname(), currentPlayer.getNickname())) {</b>
<b class="nc">&nbsp;            if (existentPlayer(currentPlayer.getNickname()))</b>
<b class="nc">&nbsp;                setPlayer(currentPlayer);</b>
&nbsp;            else
<b class="nc">&nbsp;                addPlayer(currentPlayer);</b>
<b class="nc">&nbsp;            setPions(currentPlayer);</b>
&nbsp;        }
&nbsp;
&nbsp;
<b class="nc">&nbsp;        if (!Objects.equals(currentState, &quot;objectiveState&quot;) &amp;&amp; !Objects.equals(currentState, &quot;StarterCardState&quot;) || first) {</b>
&nbsp;            //Load the first commonArea card images the first time. Then don&#39;t update them if the state is objectiveState or StarterCardState,
&nbsp;            // to avoid a change in cards before visualizing the player hand. Otherwise, it will look like the cards drawn are objectives.
<b class="nc">&nbsp;            first = false;</b>
<b class="nc">&nbsp;            addCardsToCommonArea();</b>
&nbsp;        } else
<b class="nc">&nbsp;            addCardsToCommonArea();</b>
&nbsp;
<b class="nc">&nbsp;        addCommonObjective();</b>
<b class="nc">&nbsp;        setPage();</b>
<b class="nc">&nbsp;        setPions(myself);</b>
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Displays the starterCard on the page if the player is visualizing his own page
&nbsp;     */
&nbsp;    private void starterCase() {
<b class="nc">&nbsp;        if (clickCounter == -1 &amp;&amp; Objects.equals(currentPlayerNickname, myself.getNickname())) {</b>
<b class="nc">&nbsp;            addStarterCardsToPane();</b>
<b class="nc">&nbsp;            addClickablePlaceholder(playground, layoutPlacedStarterX, layoutPlacedStarterY, fitHeightPlaced, fitWidthPlaced, this::confirmPlaceStarter);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Displays the objectiveCard on the page if the player is visualizing his own page
&nbsp;     */
&nbsp;    private void objectiveCase() {
<b class="nc">&nbsp;        if (clickCounter == -1 &amp;&amp; Objects.equals(currentPlayerNickname, myself.getNickname())) {</b>
<b class="nc">&nbsp;            setObjectives();</b>
<b class="nc">&nbsp;            addClickablePlaceholder(mainPane, layoutXObjective, layoutYObjMy, fitHeightCommon, fitWidthCommon, this::confirmPlaceObjective);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Updates the page with the information received
&nbsp;     * Updates the pions of the player, or of the current player (if they are not the same)
&nbsp;     *
&nbsp;     * @param update updatePlayerMessage received from the server
&nbsp;     */
&nbsp;    private void updatePlayerCase(updatePlayerMessage update) {
<b class="nc">&nbsp;        isUpdate = true;</b>
<b class="nc">&nbsp;        Player currentPlayer = update.getPlayer();</b>
<b class="nc">&nbsp;        if (!Objects.equals(myself.getNickname(), currentPlayer.getNickname())) {</b>
<b class="nc">&nbsp;            if (existentPlayer(currentPlayer.getNickname()))</b>
<b class="nc">&nbsp;                setPlayer(currentPlayer);</b>
&nbsp;            else
<b class="nc">&nbsp;                addPlayer(currentPlayer);</b>
<b class="nc">&nbsp;            setPions(currentPlayer);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            this.myself = update.getPlayer();</b>
<b class="nc">&nbsp;            this.myHand = update.getPlayer().getPlayerHand();</b>
<b class="nc">&nbsp;            this.myObjective = update.getPlayer().getObjective();</b>
<b class="nc">&nbsp;            this.myPlayerArea = update.getPlayer().getPlayerArea();</b>
<b class="nc">&nbsp;            setPions(myself);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        this.commonArea = update.getPlayer().getCommonArea();</b>
<b class="nc">&nbsp;        if (!Objects.equals(currentState, &quot;objectiveState&quot;) &amp;&amp; !Objects.equals(currentState, &quot;StarterCardState&quot;))</b>
<b class="nc">&nbsp;            addCardsToCommonArea();</b>
<b class="nc">&nbsp;        setPage();</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Display the new visualized player&#39;s nickname with a fade out of the previous one, and a fade in of the new one
&nbsp;     *
&nbsp;     * @param newNickname the new nickname to display
&nbsp;     */
&nbsp;    private void setPlayerNameWithFade(String newNickname) {
<b class="nc">&nbsp;        String currentNickname = playerName.getText();</b>
<b class="nc">&nbsp;        if (!currentNickname.equals(newNickname)) {</b>
&nbsp;
<b class="nc">&nbsp;            FadeTransition fadeOut = new FadeTransition(Duration.seconds(0.5), playerName);</b>
<b class="nc">&nbsp;            fadeOut.setFromValue(0.79);</b>
<b class="nc">&nbsp;            fadeOut.setToValue(0.0);</b>
<b class="nc">&nbsp;            fadeOut.play();</b>
<b class="nc">&nbsp;            fadeOut.setOnFinished(event -&gt; {</b>
<b class="nc">&nbsp;                playerName.setText(newNickname);</b>
<b class="nc">&nbsp;                Utilities.fadeInTransition(playerName, 0.79);</b>
&nbsp;            });
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;    /**
&nbsp;     * Sets the visualized page with the cards of the page&#39;s player
&nbsp;     */
&nbsp;    private void setPage() {
<b class="nc">&nbsp;        String color = (clickCounter == -1) ? myself.getColor() : players.get(clickCounter).getColor();</b>
<b class="nc">&nbsp;        setColorName(color);</b>
&nbsp;
<b class="nc">&nbsp;        String nickname = (clickCounter == -1) ? myself.getNickname() : players.get(clickCounter).getNickname();</b>
<b class="nc">&nbsp;        setPlayerNameWithFade(nickname);</b>
<b class="nc">&nbsp;        playerName.toFront();</b>
&nbsp;
<b class="nc">&nbsp;        int next = clickCounter;</b>
<b class="nc">&nbsp;        if (clickCounter == players.size() - 1) //To get the nextPlayer button color</b>
<b class="nc">&nbsp;            next = -1;</b>
&nbsp;        else
<b class="nc">&nbsp;            next++;</b>
&nbsp;
<b class="nc">&nbsp;        String nextColor = (next == -1) ? myself.getColor() : players.get(next).getColor();</b>
<b class="nc">&nbsp;        setNextButton(nextColor);</b>
&nbsp;
<b class="nc">&nbsp;        if (!currentState.equals(&quot;StarterCardState&quot;) &amp;&amp; !currentState.equals(&quot;objectiveState&quot;)) {</b>
<b class="nc">&nbsp;            if (clickCounter == -1) {</b>
<b class="nc">&nbsp;                addCardsToHand();</b>
<b class="nc">&nbsp;                addMyObjective();</b>
<b class="nc">&nbsp;                if ((Objects.equals(currentState, &quot;PlaceTurnState&quot;) &amp;&amp; Objects.equals(myself.getNickname(), currentPlayerNickname) &amp;&amp; !isUpdate) || wrong) //If it is wrong is my turn for sure</b>
<b class="nc">&nbsp;                    displayPlayerAreaAndPlaceholders(myPlayerArea);</b>
&nbsp;                else
<b class="nc">&nbsp;                    displayPlayerArea(myPlayerArea);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                addPlayerCardsToHand();</b>
<b class="nc">&nbsp;                addPlayerObjective();</b>
<b class="nc">&nbsp;                displayPlayerArea(players.get(clickCounter).getPlayerArea());</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;    /**
&nbsp;     * Displays the commonArea
&nbsp;     */
&nbsp;    private void addCardsToCommonArea() {
&nbsp;
<b class="nc">&nbsp;        Platform.runLater(() -&gt; {</b>
&nbsp;            //Add the front up cards to commonArea
<b class="nc">&nbsp;            if (commonArea.getTableCards().getFirst() == null) { //if there is no card (It should return null because commonArea is set to store null in the ArrayList if there is no card)</b>
<b class="nc">&nbsp;                removeCardFromPosition(layoutXPick0, layoutYResource); //if there is an image remove it. The method will do nothing if there is not</b>
&nbsp;            } else //if there is a card, add the image
<b class="nc">&nbsp;                addNewCardToPane(mainPane, commonArea.getTableCards().getFirst().getID(), true,</b>
<b class="nc">&nbsp;                        commonArea.getTableCards().getFirst(), layoutXPick0, layoutYResource, fitHeightCommon, fitWidthCommon, this::pickCard);</b>
&nbsp;
<b class="nc">&nbsp;            if (commonArea.getTableCards().get(1) == null) {</b>
<b class="nc">&nbsp;                removeCardFromPosition(layoutXPick1, layoutYResource);</b>
&nbsp;            } else
<b class="nc">&nbsp;                addNewCardToPane(mainPane, commonArea.getTableCards().get(1).getID(), true,</b>
<b class="nc">&nbsp;                        commonArea.getTableCards().get(1), layoutXPick1, layoutYResource, fitHeightCommon, fitWidthCommon, this::pickCard);</b>
&nbsp;
<b class="nc">&nbsp;            if (commonArea.getTableCards().get(2) == null) {</b>
<b class="nc">&nbsp;                removeCardFromPosition(layoutXPick0, layoutYGold);</b>
&nbsp;            } else
<b class="nc">&nbsp;                addNewCardToPane(mainPane, commonArea.getTableCards().get(2).getID(), true,</b>
<b class="nc">&nbsp;                        commonArea.getTableCards().get(2), layoutXPick0, layoutYGold, fitHeightCommon, fitWidthCommon, this::pickCard);</b>
&nbsp;
<b class="nc">&nbsp;            if (commonArea.getTableCards().get(3) == null) {</b>
<b class="nc">&nbsp;                removeCardFromPosition(layoutXPick1, layoutYGold);</b>
&nbsp;            } else
<b class="nc">&nbsp;                addNewCardToPane(mainPane, commonArea.getTableCards().get(3).getID(), true,</b>
<b class="nc">&nbsp;                        commonArea.getTableCards().get(3), layoutXPick1, layoutYGold, fitHeightCommon, fitWidthCommon, this::pickCard);</b>
&nbsp;
&nbsp;            //Add the cards from the decks
<b class="nc">&nbsp;            if (commonArea.getD1().getList().isEmpty()) {</b>
<b class="nc">&nbsp;                removeCardFromPosition(layoutXDeck, layoutYResource);</b>
&nbsp;            } else
<b class="nc">&nbsp;                addNewCardToPane(mainPane, commonArea.getD1().getList().getFirst().getID(), false,</b>
<b class="nc">&nbsp;                        commonArea.getD1().getList().getFirst(), layoutXDeck, layoutYResource, fitHeightCommon, fitWidthCommon, this::pickCard);</b>
&nbsp;
<b class="nc">&nbsp;            if (commonArea.getD2().getList().isEmpty()) {</b>
<b class="nc">&nbsp;                removeCardFromPosition(layoutXDeck, layoutYGold);</b>
&nbsp;            } else
<b class="nc">&nbsp;                addNewCardToPane(mainPane, commonArea.getD2().getList().getFirst().getID(), false,</b>
<b class="nc">&nbsp;                        commonArea.getD2().getList().getFirst(), layoutXDeck, layoutYGold, fitHeightCommon, fitWidthCommon, this::pickCard);</b>
&nbsp;        });
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Displays the commonObjective
&nbsp;     */
&nbsp;    private void addCommonObjective() {
<b class="nc">&nbsp;        Platform.runLater(() -&gt; {</b>
<b class="nc">&nbsp;            if (commonObjectives != null &amp;&amp; !commonObjectives.isEmpty()) {</b>
<b class="nc">&nbsp;                addNewCardToPane(mainPane, commonObjectives.get(0).getID(), true, commonObjectives.get(0), layoutXObjective,</b>
&nbsp;                        layoutYObj0, fitHeightCommon, fitWidthCommon, this::turnObjectives);
<b class="nc">&nbsp;                commonObjectives.get(0).setFront(true); //Set the front, they may arrive backwards, but I want them to be visualized front</b>
&nbsp;                //This way I will have no problem trying to doubleClick and turn them around
<b class="nc">&nbsp;                addNewCardToPane(mainPane, commonObjectives.get(1).getID(), true, commonObjectives.get(1), layoutXObjective,</b>
&nbsp;                        layoutYObj1, fitHeightCommon, fitWidthCommon, this::turnObjectives);
<b class="nc">&nbsp;                commonObjectives.get(1).setFront(true);</b>
&nbsp;            }
&nbsp;        });
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Displays the cards in the player&#39;s hand
&nbsp;     */
&nbsp;    private void addCardsToHand() {
<b class="nc">&nbsp;        if (clickCounter != -1) //If the player I am visualizing is actually not myself</b>
<b class="nc">&nbsp;            addPlayerCardsToHand();</b>
<b class="nc">&nbsp;        else if (endgame.get()) { //If the game is finished, the cards will be displayed without any eventHandler</b>
<b class="nc">&nbsp;            Platform.runLater(() -&gt; {</b>
<b class="nc">&nbsp;                for (int i = 0; i &lt; myHand.getPlaceableCards().size(); i++) {</b>
<b class="nc">&nbsp;                    addNewCardToPane(mainPane, myHand.getPlaceableCards().get(i).getID(), true,</b>
<b class="nc">&nbsp;                            myHand.getPlaceableCards().get(i), layoutXCard0 + i * 246, layoutYHand, fitHeightCard, fitWidthCard, null);</b>
&nbsp;                }
<b class="nc">&nbsp;                if (myHand.getPlaceableCards().size() == 2) //If I have two cards, the third image will be empty</b>
<b class="nc">&nbsp;                    removeCardFromPosition(layoutXCard2, layoutYHand); //This is need to avoid keeping a card in the empty place</b>
&nbsp;                //if some other player has 3 cards, I visualize his page, then get back to mine
&nbsp;            });
&nbsp;        } else {
<b class="nc">&nbsp;            Platform.runLater(() -&gt; {</b>
&nbsp;                //Get the images of the cards, or null if the position is empty
<b class="nc">&nbsp;                ImageView card0 = Utilities.getCardFromPosition(layoutXCard0, layoutYHand, mainPane);</b>
<b class="nc">&nbsp;                ImageView card1 = Utilities.getCardFromPosition(layoutXCard1, layoutYHand, mainPane);</b>
<b class="nc">&nbsp;                ImageView card2 = Utilities.getCardFromPosition(layoutXCard2, layoutYHand, mainPane);</b>
<b class="nc">&nbsp;                if (myHand.getPlaceableCards().size() == 3) {</b>
&nbsp;                    //If I have three cards, add them all
<b class="nc">&nbsp;                    for (int i = 0; i &lt; 3; i++)</b>
<b class="nc">&nbsp;                        addNewCardToPane(mainPane, myHand.getPlaceableCards().get(i).getID(), myHand.getPlaceableCards().get(i).isFront(),</b>
<b class="nc">&nbsp;                                myHand.getPlaceableCards().get(i), layoutXCard0 + i * 246, layoutYHand, fitHeightCard, fitWidthCard, this::choseCardToPlace);</b>
<b class="nc">&nbsp;                } else if (myHand.getPlaceableCards().size() == 2) { //No other player will have 2 cards</b>
&nbsp;
&nbsp;                    //if I have 2 cards, I placed one
<b class="nc">&nbsp;                    if (card0 == null)</b>
<b class="nc">&nbsp;                        layoutXSaved = layoutXCard0;</b>
<b class="nc">&nbsp;                    else if (card1 == null)</b>
<b class="nc">&nbsp;                        layoutXSaved = layoutXCard1;</b>
<b class="nc">&nbsp;                    else if (card2 == null)</b>
<b class="nc">&nbsp;                        layoutXSaved = layoutXCard2;</b>
<b class="nc">&nbsp;                    else if (layoutXSaved == 0)</b>
<b class="nc">&nbsp;                        layoutXSaved = layoutXCard2;</b>
&nbsp;
&nbsp;                    //Remove the card, so when switching to other pages, and back to mine, the cards will be displayed correctly
<b class="nc">&nbsp;                    removeCardFromPosition(layoutXSaved, layoutYHand);</b>
&nbsp;
&nbsp;                    //I saved the empty position, so I can add the remaining cards in the correct position
<b class="nc">&nbsp;                    if (layoutXSaved == layoutXCard0) {</b>
<b class="nc">&nbsp;                        addNewCardToPane(mainPane, myHand.getPlaceableCards().getFirst().getID(), myHand.getPlaceableCards().getFirst().isFront(), myHand.getPlaceableCards().getFirst(),</b>
&nbsp;                                layoutXCard1, layoutYHand, fitHeightCard, fitWidthCard, this::choseCardToPlace);
<b class="nc">&nbsp;                        addNewCardToPane(mainPane, myHand.getPlaceableCards().get(1).getID(), myHand.getPlaceableCards().get(1).isFront(), myHand.getPlaceableCards().get(1),</b>
&nbsp;                                layoutXCard2, layoutYHand, fitHeightCard, fitWidthCard, this::choseCardToPlace);
<b class="nc">&nbsp;                    } else if (layoutXSaved == layoutXCard1) {</b>
<b class="nc">&nbsp;                        addNewCardToPane(mainPane, myHand.getPlaceableCards().getFirst().getID(), myHand.getPlaceableCards().getFirst().isFront(), myHand.getPlaceableCards().getFirst(),</b>
&nbsp;                                layoutXCard0, layoutYHand, fitHeightCard, fitWidthCard, this::choseCardToPlace);
<b class="nc">&nbsp;                        addNewCardToPane(mainPane, myHand.getPlaceableCards().get(1).getID(), myHand.getPlaceableCards().get(1).isFront(), myHand.getPlaceableCards().get(1),</b>
&nbsp;                                layoutXCard2, layoutYHand, fitHeightCard, fitWidthCard, this::choseCardToPlace);
&nbsp;                    } else {
<b class="nc">&nbsp;                        addNewCardToPane(mainPane, myHand.getPlaceableCards().getFirst().getID(), myHand.getPlaceableCards().getFirst().isFront(), myHand.getPlaceableCards().getFirst(),</b>
&nbsp;                                layoutXCard0, layoutYHand, fitHeightCard, fitWidthCard, this::choseCardToPlace);
<b class="nc">&nbsp;                        addNewCardToPane(mainPane, myHand.getPlaceableCards().get(1).getID(), myHand.getPlaceableCards().get(1).isFront(), myHand.getPlaceableCards().get(1),</b>
&nbsp;                                layoutXCard1, layoutYHand, fitHeightCard, fitWidthCard, this::choseCardToPlace);
&nbsp;                    }
&nbsp;                }
&nbsp;            });
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;    /**
&nbsp;     * Displays visualized player&#39;s cards in the player&#39;s hand back
&nbsp;     */
&nbsp;    private void addPlayerCardsToHand() {
&nbsp;        //This works as the addCardsToHand, but for the player I am visualizing, so the cards will be back and have no eventHandler
<b class="nc">&nbsp;        if (clickCounter == -1)</b>
<b class="nc">&nbsp;            addCardsToHand();</b>
<b class="nc">&nbsp;        else if (endgame.get()) {</b>
<b class="nc">&nbsp;            Platform.runLater(() -&gt; {</b>
<b class="nc">&nbsp;                PlayerHand hand = players.get(clickCounter).getPlayerHand();</b>
<b class="nc">&nbsp;                for (int i = 0; i &lt; hand.getPlaceableCards().size(); i++) {</b>
<b class="nc">&nbsp;                    addNewCardToPane(mainPane, hand.getPlaceableCards().get(i).getID(), true,</b>
<b class="nc">&nbsp;                            hand.getPlaceableCards().get(i), layoutXCard0 + i * 246, layoutYHand, fitHeightCard, fitWidthCard, null);</b>
&nbsp;                }
<b class="nc">&nbsp;                if (hand.getPlaceableCards().size() == 2)</b>
<b class="nc">&nbsp;                    removeCardFromPosition(layoutXCard2, layoutYHand);</b>
&nbsp;            });
&nbsp;        } else {
<b class="nc">&nbsp;            PlayerHand hand = players.get(clickCounter).getPlayerHand();</b>
<b class="nc">&nbsp;            ImageView card0 = Utilities.getCardFromPosition(layoutXCard0, layoutYHand, mainPane);</b>
<b class="nc">&nbsp;            ImageView card1 = Utilities.getCardFromPosition(layoutXCard1, layoutYHand, mainPane);</b>
<b class="nc">&nbsp;            ImageView card2 = Utilities.getCardFromPosition(layoutXCard2, layoutYHand, mainPane);</b>
<b class="nc">&nbsp;            Platform.runLater(() -&gt; {</b>
<b class="nc">&nbsp;                if (hand.getPlaceableCards().size() == 3) {</b>
<b class="nc">&nbsp;                    for (int i = 0; i &lt; 3; i++)</b>
<b class="nc">&nbsp;                        addNewCardToPane(mainPane, hand.getPlaceableCards().get(i).getID(), false,</b>
<b class="nc">&nbsp;                                hand.getPlaceableCards().get(i), layoutXCard0 + i * 246, layoutYHand, fitHeightCard, fitWidthCard, null);</b>
<b class="nc">&nbsp;                } else if (hand.getPlaceableCards().size() == 2) {</b>
<b class="nc">&nbsp;                    if (card0 == null)</b>
<b class="nc">&nbsp;                        layoutXSaved = layoutXCard0;</b>
<b class="nc">&nbsp;                    else if (card1 == null)</b>
<b class="nc">&nbsp;                        layoutXSaved = layoutXCard1;</b>
<b class="nc">&nbsp;                    else if (card2 == null)</b>
<b class="nc">&nbsp;                        layoutXSaved = layoutXCard2;</b>
<b class="nc">&nbsp;                    else if (layoutXSaved == 0)</b>
<b class="nc">&nbsp;                        layoutXSaved = layoutXCard2;</b>
&nbsp;
<b class="nc">&nbsp;                    removeCardFromPosition(layoutXSaved, layoutYHand);</b>
&nbsp;
<b class="nc">&nbsp;                    if (layoutXSaved == layoutXCard0) {</b>
<b class="nc">&nbsp;                        addNewCardToPane(mainPane, hand.getPlaceableCards().getFirst().getID(), false, hand.getPlaceableCards().getFirst(),</b>
&nbsp;                                layoutXCard1, layoutYHand, fitHeightCard, fitWidthCard, null);
<b class="nc">&nbsp;                        addNewCardToPane(mainPane, hand.getPlaceableCards().get(1).getID(), false, hand.getPlaceableCards().get(1),</b>
&nbsp;                                layoutXCard2, layoutYHand, fitHeightCard, fitWidthCard, null);
<b class="nc">&nbsp;                    } else if (layoutXSaved == layoutXCard1) {</b>
<b class="nc">&nbsp;                        addNewCardToPane(mainPane, hand.getPlaceableCards().getFirst().getID(), false, hand.getPlaceableCards().getFirst(),</b>
&nbsp;                                layoutXCard0, layoutYHand, fitHeightCard, fitWidthCard, null);
<b class="nc">&nbsp;                        addNewCardToPane(mainPane, hand.getPlaceableCards().get(1).getID(), false, hand.getPlaceableCards().get(1),</b>
&nbsp;                                layoutXCard2, layoutYHand, fitHeightCard, fitWidthCard, null);
&nbsp;                    } else {
<b class="nc">&nbsp;                        addNewCardToPane(mainPane, hand.getPlaceableCards().getFirst().getID(), false, hand.getPlaceableCards().getFirst(),</b>
&nbsp;                                layoutXCard0, layoutYHand, fitHeightCard, fitWidthCard, null);
<b class="nc">&nbsp;                        addNewCardToPane(mainPane, hand.getPlaceableCards().get(1).getID(), false, hand.getPlaceableCards().get(1),</b>
&nbsp;                                layoutXCard1, layoutYHand, fitHeightCard, fitWidthCard, null);
&nbsp;                    }
&nbsp;                }
&nbsp;            });
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Displays the player&#39;s personal objective
&nbsp;     */
&nbsp;    private void addMyObjective() {
<b class="nc">&nbsp;        if (clickCounter != -1)</b>
<b class="nc">&nbsp;            addPlayerObjective();</b>
&nbsp;        else {
<b class="nc">&nbsp;            if (myObjective != null) {</b>
<b class="nc">&nbsp;                Platform.runLater(() -&gt; {</b>
<b class="nc">&nbsp;                    addNewCardToPane(mainPane, myObjective.getID(), true, myObjective, layoutXObjective, layoutYObjMy, fitHeightCommon, fitWidthCommon, this::turnObjectives);</b>
<b class="nc">&nbsp;                    myObjective.setFront(true); //Forcefully set it to true, in case it is received backwards</b>
&nbsp;                });
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Displays the visualized player&#39;s secret objective back
&nbsp;     */
&nbsp;    private void addPlayerObjective() {
<b class="nc">&nbsp;        if (clickCounter == -1)</b>
<b class="nc">&nbsp;            addMyObjective();</b>
&nbsp;        else {
<b class="nc">&nbsp;            if (endgame.get()) {</b>
<b class="nc">&nbsp;                Platform.runLater(() -&gt; addNewCardToPane(mainPane, players.get(clickCounter).getObjective().getID(), true, players.get(clickCounter).getObjective(),</b>
&nbsp;                        layoutXObjective, layoutYObjMy, fitHeightCommon, fitWidthCommon, this::turnObjectives));
<b class="nc">&nbsp;                players.get(clickCounter).getObjective().setFront(true);</b>
&nbsp;            } else
<b class="nc">&nbsp;                Platform.runLater(() -&gt; addNewCardToPane(mainPane, players.get(clickCounter).getObjective().getID(), false, players.get(clickCounter).getObjective(),</b>
&nbsp;                        layoutXObjective, layoutYObjMy, fitHeightCommon, fitWidthCommon, null));
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Displays the starterCard in player&#39;s hand
&nbsp;     */
&nbsp;    private void addStarterCardsToPane() {
<b class="nc">&nbsp;        Platform.runLater(() -&gt; {</b>
<b class="nc">&nbsp;            addNewCardToPane(mainPane, myself.getPlayerHand().getPlaceableCards().getFirst().getID(), true,</b>
<b class="nc">&nbsp;                    myself.getPlayerHand().getPlaceableCards().getFirst(), layoutXCard1, layoutYHand, fitHeightCard, fitWidthCard, this::placeStarter);</b>
<b class="nc">&nbsp;            myself.getPlayerHand().getPlaceableCards().getFirst().setFront(true); //Forcefully set it to true, in case it is received backwards</b>
&nbsp;        });
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Displays the two objectives from which the player can choose
&nbsp;     */
&nbsp;    private void setObjectives() {
<b class="nc">&nbsp;        Platform.runLater(() -&gt; {</b>
<b class="nc">&nbsp;            addNewCardToPane(mainPane, objectivesToChose.get(0).getID(), true, objectivesToChose.get(0), layoutXChoiceObjective1, layoutYHand, fitHeightCard,</b>
&nbsp;                    fitWidthCard, this::chooseObjective);
<b class="nc">&nbsp;            objectivesToChose.get(0).setFront(true);</b>
<b class="nc">&nbsp;            addNewCardToPane(mainPane, objectivesToChose.get(1).getID(), true, objectivesToChose.get(1), layoutXChoiceObjective2, layoutYHand, fitHeightCard,</b>
&nbsp;                    fitWidthCard, this::chooseObjective);
<b class="nc">&nbsp;            objectivesToChose.get(1).setFront(true);</b>
&nbsp;        });
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Displays the cards placeholders that can be clicked to select the position where to place the card
&nbsp;     * in the playground and to place the objective in the objective area
&nbsp;     *
&nbsp;     * @param pane         the pane where to display the placeholders
&nbsp;     * @param layoutX      the x position of the placeholder
&nbsp;     * @param layoutY      the y position of the placeholder
&nbsp;     * @param fitHeight    the height of the placeholder
&nbsp;     * @param fitWidth     the width of the placeholder
&nbsp;     * @param eventHandler the event handler to call when the placeholder is clicked
&nbsp;     */
&nbsp;    private void addClickablePlaceholder(Pane pane, double layoutX, double layoutY, double fitHeight, double fitWidth, EventHandler&lt;MouseEvent&gt; eventHandler) {
<b class="nc">&nbsp;        Image image = Utilities.randomColorForPlaceholder();</b>
&nbsp;
&nbsp;        // Check if image with the same position and size already exists
<b class="nc">&nbsp;        boolean exists = pane.getChildren().stream()</b>
<b class="nc">&nbsp;                .filter(node -&gt; node instanceof ImageView)</b>
<b class="nc">&nbsp;                .anyMatch(node -&gt; {</b>
<b class="nc">&nbsp;                    ImageView imageView = (ImageView) node;</b>
<b class="nc">&nbsp;                    return imageView.getLayoutX() == layoutX &amp;&amp; imageView.getLayoutY() == layoutY &amp;&amp;</b>
<b class="nc">&nbsp;                            imageView.getFitWidth() == fitWidth &amp;&amp; imageView.getFitHeight() == fitHeight;</b>
&nbsp;                });
&nbsp;
<b class="nc">&nbsp;        if (!exists) {</b>
&nbsp;
&nbsp;
<b class="nc">&nbsp;            Utilities.createClickablePane(pane, layoutX, layoutY, fitHeight, fitWidth, eventHandler, image);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Checks if the currentPlayer is already in the list of players
&nbsp;     *
&nbsp;     * @param currentPlayer the nickname of the player to check
&nbsp;     * @return true if the player is already in the list, false otherwise
&nbsp;     */
&nbsp;    private boolean existentPlayer(String currentPlayer) {
<b class="nc">&nbsp;        for (Player player : players) {</b>
<b class="nc">&nbsp;            if (player.getNickname().equals(currentPlayer))</b>
<b class="nc">&nbsp;                return true;</b>
&nbsp;        }
<b class="nc">&nbsp;        return false;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Updates the player in the list of players
&nbsp;     *
&nbsp;     * @param currentPlayer the player to update
&nbsp;     */
&nbsp;    private void setPlayer(Player currentPlayer) {
<b class="nc">&nbsp;        for (int i = 0; i &lt; players.size(); i++) {</b>
<b class="nc">&nbsp;            if (players.get(i).getNickname().equals(currentPlayer.getNickname())) {</b>
<b class="nc">&nbsp;                players.set(i, currentPlayer);</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Adds the player to the list of players
&nbsp;     *
&nbsp;     * @param currentPlayer the player to add
&nbsp;     */
&nbsp;    private void addPlayer(Player currentPlayer) {
<b class="nc">&nbsp;        players.add(currentPlayer);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Removes a card from the pane.
&nbsp;     *
&nbsp;     * @param layoutX the x position of the card
&nbsp;     * @param layoutY the y position of the card
&nbsp;     */
&nbsp;    private void removeCardFromPosition(double layoutX, double layoutY) {
<b class="nc">&nbsp;        Platform.runLater(() -&gt; {</b>
<b class="nc">&nbsp;            List&lt;Node&gt; nodesToRemove = mainPane.getChildren().stream()</b>
<b class="nc">&nbsp;                    .filter(node -&gt; node instanceof ImageView)</b>
<b class="nc">&nbsp;                    .filter(node -&gt; {</b>
<b class="nc">&nbsp;                        ImageView imageView = (ImageView) node;</b>
<b class="nc">&nbsp;                        return imageView.getLayoutX() == layoutX &amp;&amp; imageView.getLayoutY() == layoutY;</b>
&nbsp;                    })
<b class="nc">&nbsp;                    .toList();</b>
&nbsp;
&nbsp;            // Remove nodes after iteration
<b class="nc">&nbsp;            for (Node node : nodesToRemove) {</b>
<b class="nc">&nbsp;                ImageView imageView = (ImageView) node;</b>
<b class="nc">&nbsp;                if (imageView.getUserData() instanceof Card)</b>
<b class="nc">&nbsp;                    Utilities.fadeOutTransition(mainPane, imageView, 1, true);</b>
&nbsp;                else
<b class="nc">&nbsp;                    Utilities.fadeOutTransition(mainPane, imageView, 0.5, true);</b>
&nbsp;            }
&nbsp;        });
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Removes a card from the playerHand, when the card is placed.
&nbsp;     *
&nbsp;     * @param layoutX  the x position of the card
&nbsp;     * @param layoutY  the y position of the card
&nbsp;     * @param onFinish the runnable to call when the card is removed
&nbsp;     */
&nbsp;    private void removeCardFromPositionForHandCard(double layoutX, double layoutY, Runnable onFinish) {
<b class="nc">&nbsp;        Platform.runLater(() -&gt; {</b>
<b class="nc">&nbsp;            List&lt;Node&gt; nodesToRemove = mainPane.getChildren().stream()</b>
<b class="nc">&nbsp;                    .filter(node -&gt; node instanceof ImageView)</b>
<b class="nc">&nbsp;                    .filter(node -&gt; {</b>
<b class="nc">&nbsp;                        ImageView imageView = (ImageView) node;</b>
<b class="nc">&nbsp;                        return imageView.getLayoutX() == layoutX &amp;&amp; imageView.getLayoutY() == layoutY;</b>
&nbsp;                    })
<b class="nc">&nbsp;                    .toList();</b>
&nbsp;
<b class="nc">&nbsp;            if (nodesToRemove.isEmpty()) {  //Nothing to remove</b>
<b class="nc">&nbsp;                if (onFinish != null) {</b>
<b class="nc">&nbsp;                    onFinish.run();</b>
&nbsp;                }
&nbsp;                return;
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            AtomicInteger nodesRemovedCount = new AtomicInteger(0);</b>
<b class="nc">&nbsp;            int totalNodesToRemove = nodesToRemove.size();</b>
&nbsp;
<b class="nc">&nbsp;            for (Node node : nodesToRemove) {</b>
<b class="nc">&nbsp;                ImageView imageView = (ImageView) node;</b>
<b class="nc">&nbsp;                Runnable nodeRemoveCallback = () -&gt; {</b>
<b class="nc">&nbsp;                    if (nodesRemovedCount.incrementAndGet() == totalNodesToRemove &amp;&amp; onFinish != null) {</b>
<b class="nc">&nbsp;                        onFinish.run();</b>
&nbsp;                    }
&nbsp;                };
&nbsp;
<b class="nc">&nbsp;                if (imageView.getUserData() instanceof Card)</b>
<b class="nc">&nbsp;                    fadeOutTransitionForHandCard(mainPane, imageView, 1, nodeRemoveCallback);</b>
&nbsp;                else
<b class="nc">&nbsp;                    fadeOutTransitionForHandCard(mainPane, imageView, 0.5, nodeRemoveCallback);</b>
&nbsp;            }
&nbsp;        });
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Fades out the card and removes it from the pane
&nbsp;     *
&nbsp;     * @param pane     the pane where the card is
&nbsp;     * @param card     the card to remove
&nbsp;     * @param duration the duration of the fade out transition
&nbsp;     * @param onFinish the runnable to call when the card is removed
&nbsp;     */
&nbsp;    private void fadeOutTransitionForHandCard(Pane pane, ImageView card, double duration, Runnable onFinish) {
<b class="nc">&nbsp;        FadeTransition fadeTransition = new FadeTransition(Duration.seconds(duration), card);</b>
<b class="nc">&nbsp;        fadeTransition.setFromValue(1.0);</b>
<b class="nc">&nbsp;        fadeTransition.setToValue(0.0);</b>
<b class="nc">&nbsp;        fadeTransition.setOnFinished(event -&gt; {</b>
<b class="nc">&nbsp;            pane.getChildren().remove(card);</b>
<b class="nc">&nbsp;            if (onFinish != null) {</b>
<b class="nc">&nbsp;                onFinish.run();</b>
&nbsp;            }
&nbsp;        });
<b class="nc">&nbsp;        fadeTransition.play();</b>
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;    /**
&nbsp;     * Adds a new card to the pane if it doesn&#39;t exist already in the same position and with the same ID
&nbsp;     *
&nbsp;     * @param pane         the pane where to add the card
&nbsp;     * @param cardID       the ID of the card
&nbsp;     * @param front        if the card is front up
&nbsp;     * @param card         the card to add
&nbsp;     * @param layoutX      the x position of the card
&nbsp;     * @param layoutY      the y position of the card
&nbsp;     * @param fitHeight    the height of the card
&nbsp;     * @param fitWidth     the width of the card
&nbsp;     * @param eventHandler the event handler to call when the card is clicked
&nbsp;     */
&nbsp;    private void addNewCardToPane(Pane pane, int cardID, boolean front, Card card, double layoutX, double layoutY, double fitHeight, double fitWidth, EventHandler&lt;MouseEvent&gt; eventHandler) {
<b class="nc">&nbsp;        ImageView existingCard = pane.getChildren().stream()</b>
<b class="nc">&nbsp;                .filter(node -&gt; node instanceof ImageView)</b>
<b class="nc">&nbsp;                .map(node -&gt; (ImageView) node)</b>
<b class="nc">&nbsp;                .filter(imageView -&gt; {</b>
<b class="nc">&nbsp;                    Card existing = (Card) imageView.getUserData();</b>
<b class="nc">&nbsp;                    return existing != null &amp;&amp; existing.getID() == cardID &amp;&amp;</b>
<b class="nc">&nbsp;                            imageView.getLayoutX() == layoutX &amp;&amp; imageView.getLayoutY() == layoutY;</b>
&nbsp;                })
<b class="nc">&nbsp;                .findFirst()</b>
<b class="nc">&nbsp;                .orElse(null);</b>
&nbsp;
<b class="nc">&nbsp;        if (existingCard == null) {</b>
&nbsp;            // Card with the same ID and position doesn&#39;t exist, so remove the existing card and load the new one
<b class="nc">&nbsp;            removeCardFromPosition(layoutX, layoutY);</b>
<b class="nc">&nbsp;            ImageView newCard = Utilities.createCardImageView(cardID, front, card, layoutX, layoutY, fitHeight, fitWidth);</b>
<b class="nc">&nbsp;            if (eventHandler != null) {</b>
<b class="nc">&nbsp;                newCard.setOnMouseClicked(eventHandler);</b>
&nbsp;            }
<b class="nc">&nbsp;            if (pane == mainPane)</b>
<b class="nc">&nbsp;                Utilities.hooverEffect(newCard, 1.05);</b>
&nbsp;
<b class="nc">&nbsp;            Platform.runLater(() -&gt; {</b>
<b class="nc">&nbsp;                pane.getChildren().add(newCard);</b>
<b class="nc">&nbsp;                Utilities.fadeInTransition(newCard, 1.0);</b>
<b class="nc">&nbsp;                onTop.toFront();</b>
&nbsp;            });
&nbsp;            // If Card with the same ID and position exists, do nothing
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void turnObjectives(MouseEvent event) {
<b class="nc">&nbsp;        if (event.getClickCount() == 2) {</b>
<b class="nc">&nbsp;            Utilities.turnAround(event);</b>
<b class="nc">&nbsp;            onTop.toFront();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Selects the card when clicked once, making it bigger and stores this selection in selectedCard
&nbsp;     * Turns the card around when clicked twice
&nbsp;     *
&nbsp;     * @param event the mouse event
&nbsp;     */
&nbsp;    private void placeStarter(MouseEvent event) {
<b class="nc">&nbsp;        if (clickCounter == -1) {</b>
<b class="nc">&nbsp;            ImageView clickedCard = (ImageView) event.getSource();</b>
<b class="nc">&nbsp;            StarterCard card = (StarterCard) clickedCard.getUserData();</b>
<b class="nc">&nbsp;            boolean isFront = card.isFront();</b>
&nbsp;
<b class="nc">&nbsp;            if (event.getClickCount() == 1) {</b>
&nbsp;
<b class="nc">&nbsp;                if (selectedCard != null) {</b>
<b class="nc">&nbsp;                    Utilities.makeSmallerTransition(selectedCard);</b>
<b class="nc">&nbsp;                    Utilities.hooverEffect(selectedCard, 1.05);</b>
&nbsp;                }
&nbsp;
<b class="nc">&nbsp;                Utilities.removeHooverEffect(clickedCard);</b>
<b class="nc">&nbsp;                Utilities.makeBiggerTransition(clickedCard, 1.05);</b>
<b class="nc">&nbsp;                selectedCard = clickedCard;</b>
&nbsp;
<b class="nc">&nbsp;                selectedStarterFront = isFront ? 1 : 0;</b>
&nbsp;
<b class="nc">&nbsp;            } else if (event.getClickCount() == 2) {</b>
<b class="nc">&nbsp;                Utilities.turnAround(event);</b>
<b class="nc">&nbsp;                onTop.toFront();</b>
<b class="nc">&nbsp;                if (selectedStarterFront == 1)</b>
<b class="nc">&nbsp;                    selectedStarterFront = 0;</b>
&nbsp;                else
<b class="nc">&nbsp;                    selectedStarterFront = 1;</b>
&nbsp;
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Selects the card when clicked once, making it bigger and stores this selection in selectedCard
&nbsp;     * Turns the card around when clicked twice
&nbsp;     *
&nbsp;     * @param event the mouse event
&nbsp;     */
&nbsp;    private void chooseObjective(MouseEvent event) {
<b class="nc">&nbsp;        ImageView clickedCard = (ImageView) event.getSource();</b>
<b class="nc">&nbsp;        ObjectiveCard card = (ObjectiveCard) clickedCard.getUserData();</b>
<b class="nc">&nbsp;        int cardID = card.getID();</b>
&nbsp;
<b class="nc">&nbsp;        if (event.getClickCount() == 1) {</b>
<b class="nc">&nbsp;            if (selectedCard != null) {</b>
<b class="nc">&nbsp;                Utilities.makeSmallerTransition(selectedCard);</b>
<b class="nc">&nbsp;                Utilities.hooverEffect(selectedCard, 1.05);</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            Utilities.removeHooverEffect(clickedCard);</b>
<b class="nc">&nbsp;            Utilities.makeBiggerTransition(clickedCard, 1.05);</b>
<b class="nc">&nbsp;            selectedCard = clickedCard;</b>
&nbsp;
<b class="nc">&nbsp;            if (cardID == objectivesToChose.get(0).getID()) {</b>
<b class="nc">&nbsp;                selectedObjective = 1;</b>
<b class="nc">&nbsp;            } else if (cardID == objectivesToChose.get(1).getID()) {</b>
<b class="nc">&nbsp;                selectedObjective = 2;</b>
&nbsp;            }
<b class="nc">&nbsp;        } else if (event.getClickCount() == 2) {</b>
<b class="nc">&nbsp;            Utilities.turnAround(event);</b>
<b class="nc">&nbsp;            onTop.toFront();</b>
<b class="nc">&nbsp;            if (cardID == objectivesToChose.get(0).getID()) {</b>
<b class="nc">&nbsp;                selectedObjective = 1;</b>
<b class="nc">&nbsp;            } else if (cardID == objectivesToChose.get(1).getID()) {</b>
<b class="nc">&nbsp;                selectedObjective = 2;</b>
&nbsp;            }
&nbsp;
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * If there is a selected card, it sends the information about the selectedCard to the server
&nbsp;     *
&nbsp;     * @param event the mouse event
&nbsp;     */
&nbsp;    private void confirmPlaceStarter(MouseEvent event) {
<b class="nc">&nbsp;        if (selectedCard != null) {</b>
<b class="nc">&nbsp;            ImageView image = (ImageView) event.getSource();</b>
<b class="nc">&nbsp;            Utilities.fadeOutTransition(mainPane, image, 0.5, true);</b>
<b class="nc">&nbsp;            removeCardFromPosition(layoutXCard1, layoutYHand);</b>
<b class="nc">&nbsp;            StarterCard card = (StarterCard) selectedCard.getUserData();</b>
<b class="nc">&nbsp;            addNewCardToPane(playground, card.getID(), card.isFront(), card, layoutPlacedStarterX, layoutPlacedStarterY,</b>
&nbsp;                    fitHeightPlaced, fitWidthPlaced, null);
<b class="nc">&nbsp;            GUIMessages.writeToClient(selectedStarterFront);</b>
<b class="nc">&nbsp;            selectedCard = null;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * If there is a selected card, it sends the information about the selectedCard to the server
&nbsp;     *
&nbsp;     * @param event the mouse event
&nbsp;     */
&nbsp;    private void confirmPlaceObjective(MouseEvent event) {
<b class="nc">&nbsp;        if (selectedCard != null) {</b>
<b class="nc">&nbsp;            ImageView image = (ImageView) event.getSource();</b>
<b class="nc">&nbsp;            ObjectiveCard card = (ObjectiveCard) selectedCard.getUserData();</b>
<b class="nc">&nbsp;            Utilities.fadeOutTransition(mainPane, image, 0.5, true);</b>
<b class="nc">&nbsp;            ImageView obj1 = Utilities.getCardFromPosition(layoutXChoiceObjective1, layoutYHand, mainPane);</b>
<b class="nc">&nbsp;            ImageView obj2 = Utilities.getCardFromPosition(layoutXChoiceObjective2, layoutYHand, mainPane);</b>
<b class="nc">&nbsp;            Utilities.fadeOutTransition(mainPane, obj1, 1, true);</b>
<b class="nc">&nbsp;            Utilities.fadeOutTransition(mainPane, obj2, 1, true);</b>
<b class="nc">&nbsp;            addNewCardToPane(mainPane, card.getID(), card.isFront(), card, layoutXObjective, layoutYObjMy, fitHeightCommon,</b>
&nbsp;                    fitWidthCommon, this::turnObjectives);
<b class="nc">&nbsp;            GUIMessages.writeToClient(selectedObjective);</b>
<b class="nc">&nbsp;            selectedCard = null;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * When the mouse is clicked once, and if the page visualized is the client&#39;s, it selects the card to place
&nbsp;     * When the mouse is clicked twice, it turns the card around
&nbsp;     *
&nbsp;     * @param event the mouse event
&nbsp;     */
&nbsp;    private void choseCardToPlace(MouseEvent event) {
<b class="nc">&nbsp;        if (clickCounter == -1) {</b>
<b class="nc">&nbsp;            ImageView clickedCard = (ImageView) event.getSource();</b>
<b class="nc">&nbsp;            PlaceableCard card = (PlaceableCard) clickedCard.getUserData();</b>
<b class="nc">&nbsp;            int cardID = card.getID();</b>
&nbsp;
<b class="nc">&nbsp;            if (event.getClickCount() == 1 &amp;&amp; Objects.equals(currentState, &quot;PlaceTurnState&quot;) &amp;&amp; Objects.equals(currentPlayerNickname, myself.getNickname())) {</b>
<b class="nc">&nbsp;                if (selectedCard != null) {</b>
<b class="nc">&nbsp;                    Utilities.makeSmallerTransition(selectedCard);</b>
<b class="nc">&nbsp;                    Utilities.hooverEffect(selectedCard, 1.05);</b>
&nbsp;                }
&nbsp;
<b class="nc">&nbsp;                Utilities.removeHooverEffect(clickedCard);</b>
<b class="nc">&nbsp;                Utilities.makeBiggerTransition(clickedCard, 1.05);</b>
<b class="nc">&nbsp;                selectedCard = clickedCard;</b>
&nbsp;
<b class="nc">&nbsp;                if (cardID == myHand.getPlaceableCards().getFirst().getID())</b>
<b class="nc">&nbsp;                    selectedToPlace[0] = 0;</b>
<b class="nc">&nbsp;                else if (cardID == myHand.getPlaceableCards().get(1).getID())</b>
<b class="nc">&nbsp;                    selectedToPlace[0] = 1;</b>
<b class="nc">&nbsp;                else if (cardID == myHand.getPlaceableCards().get(2).getID())</b>
<b class="nc">&nbsp;                    selectedToPlace[0] = 2;</b>
&nbsp;
<b class="nc">&nbsp;                selectedToPlace[1] = card.isFront() ? 1 : 0;</b>
<b class="nc">&nbsp;            } else if (event.getClickCount() == 2) {</b>
<b class="nc">&nbsp;                Utilities.turnAround(event);</b>
<b class="nc">&nbsp;                onTop.toFront();</b>
&nbsp;
<b class="nc">&nbsp;                if (Objects.equals(currentState, &quot;PlaceTurnState&quot;) &amp;&amp; Objects.equals(currentPlayerNickname, myself.getNickname())) {</b>
<b class="nc">&nbsp;                    if (cardID == myHand.getPlaceableCards().getFirst().getID())</b>
<b class="nc">&nbsp;                        selectedToPlace[0] = 0;</b>
<b class="nc">&nbsp;                    else if (cardID == myHand.getPlaceableCards().get(1).getID())</b>
<b class="nc">&nbsp;                        selectedToPlace[0] = 1;</b>
<b class="nc">&nbsp;                    else if (cardID == myHand.getPlaceableCards().get(2).getID())</b>
<b class="nc">&nbsp;                        selectedToPlace[0] = 2;</b>
&nbsp;
<b class="nc">&nbsp;                    if (selectedToPlace[1] == 1)</b>
<b class="nc">&nbsp;                        selectedToPlace[1] = 0;</b>
&nbsp;                    else
<b class="nc">&nbsp;                        selectedToPlace[1] = 1;</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * When the mouse is clicked, it selects the position where to place the card
&nbsp;     * and send all the information needed to the server
&nbsp;     *
&nbsp;     * @param event the mouse event
&nbsp;     */
&nbsp;    private void confirmPlaceCard(MouseEvent event) {
<b class="nc">&nbsp;        if (selectedCard != null) {</b>
<b class="nc">&nbsp;            Utilities.makeSmallerTransition(selectedCard);</b>
&nbsp;
&nbsp;            // Get the placeholder that was clicked
<b class="nc">&nbsp;            ImageView clickedPlaceholder = (ImageView) event.getSource();</b>
&nbsp;
&nbsp;            // Retrieve the original row and column from the ImageView properties
<b class="nc">&nbsp;            int originalRow = (int) clickedPlaceholder.getProperties().get(&quot;originalRow&quot;);</b>
<b class="nc">&nbsp;            int originalColumn = (int) clickedPlaceholder.getProperties().get(&quot;originalColumn&quot;);</b>
&nbsp;
&nbsp;            // Update the selectedToPlace array with the original positions
<b class="nc">&nbsp;            selectedToPlace[2] = originalRow;</b>
<b class="nc">&nbsp;            selectedToPlace[3] = originalColumn;</b>
&nbsp;
<b class="nc">&nbsp;            removeCardFromPositionForHandCard(selectedCard.getLayoutX(), selectedCard.getLayoutY(), () -&gt; {</b>
<b class="nc">&nbsp;                GUIMessages.writeToClient(selectedToPlace);</b>
<b class="nc">&nbsp;                wrong = false;</b>
<b class="nc">&nbsp;                selectedCard = null;</b>
&nbsp;            });
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * When the mouse is clicked, it selects the card to pick
&nbsp;     *
&nbsp;     * @param event the mouse event
&nbsp;     */
&nbsp;    private void pickCard(MouseEvent event) {
<b class="nc">&nbsp;        if (clickCounter == -1 &amp;&amp; Objects.equals(currentState, &quot;PickTurnState&quot;) &amp;&amp; !isLastTurn) {</b>
<b class="nc">&nbsp;            ImageView clickedCard = (ImageView) event.getSource();</b>
<b class="nc">&nbsp;            Card card = (Card) clickedCard.getUserData();</b>
<b class="nc">&nbsp;            int cardID = card.getID();</b>
&nbsp;
<b class="nc">&nbsp;            if (selectedCard != null) {</b>
<b class="nc">&nbsp;                Utilities.makeSmallerTransition(selectedCard);</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            selectedCard = clickedCard;</b>
<b class="nc">&nbsp;            if (!commonArea.getD1().getList().isEmpty() &amp;&amp; cardID == commonArea.getD1().getList().getFirst().getID())</b>
<b class="nc">&nbsp;                selectedPick = 1;</b>
<b class="nc">&nbsp;            else if (!commonArea.getD2().getList().isEmpty() &amp;&amp; cardID == commonArea.getD2().getList().getFirst().getID())</b>
<b class="nc">&nbsp;                selectedPick = 2;</b>
<b class="nc">&nbsp;            else if (commonArea.getTableCards().getFirst() != null &amp;&amp; cardID == commonArea.getTableCards().getFirst().getID())</b>
<b class="nc">&nbsp;                selectedPick = 3;</b>
<b class="nc">&nbsp;            else if (commonArea.getTableCards().get(1) != null &amp;&amp; cardID == commonArea.getTableCards().get(1).getID())</b>
<b class="nc">&nbsp;                selectedPick = 4;</b>
<b class="nc">&nbsp;            else if (commonArea.getTableCards().get(2) != null &amp;&amp; cardID == commonArea.getTableCards().get(2).getID())</b>
<b class="nc">&nbsp;                selectedPick = 5;</b>
<b class="nc">&nbsp;            else if (commonArea.getTableCards().get(3) != null &amp;&amp; cardID == commonArea.getTableCards().get(3).getID())</b>
<b class="nc">&nbsp;                selectedPick = 6;</b>
&nbsp;
<b class="nc">&nbsp;            GUIMessages.writeToClient(selectedPick);</b>
<b class="nc">&nbsp;            selectedCard = null;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * When clicked, it displays the NextButton player&#39;s page or the client&#39;s page
&nbsp;     * If the state is StarterCardState or objectiveState, it displays a popup
&nbsp;     */
&nbsp;    @FXML
&nbsp;    private void switchToNextPlayer() {
<b class="nc">&nbsp;        nextPlayer.setDisable(true);</b>
&nbsp;
<b class="nc">&nbsp;        if (!Objects.equals(currentState, &quot;StarterCardState&quot;) &amp;&amp; !Objects.equals(currentState, &quot;objectiveState&quot;)) {</b>
<b class="nc">&nbsp;            clickCounter++;</b>
<b class="nc">&nbsp;            if (clickCounter == players.size()) {</b>
<b class="nc">&nbsp;                clickCounter = -1;</b>
&nbsp;            }
<b class="nc">&nbsp;            setPage();</b>
<b class="nc">&nbsp;        } else if ((Objects.equals(currentState, &quot;StarterCardState&quot;) || Objects.equals(currentState, &quot;objectiveState&quot;)) &amp;&amp; Objects.equals(currentPlayerNickname, myself.getNickname())) {</b>
<b class="nc">&nbsp;            choosePopUp(myself.getColor());</b>
<b class="nc">&nbsp;        } else if (Objects.equals(currentState, &quot;StarterCardState&quot;) || Objects.equals(currentState, &quot;objectiveState&quot;)) {</b>
<b class="nc">&nbsp;            waitPopUp(myself.getColor());</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        PauseTransition pause = new PauseTransition(Duration.seconds(1));</b>
<b class="nc">&nbsp;        pause.setOnFinished(event -&gt; nextPlayer.setDisable(false));</b>
<b class="nc">&nbsp;        pause.play();</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Displays the pions positions based on color
&nbsp;     *
&nbsp;     * @param player the player to set the pions positions
&nbsp;     */
&nbsp;    private void setPions(Player player) {
<b class="nc">&nbsp;        Platform.runLater(() -&gt; {</b>
<b class="nc">&nbsp;            String color = player.getColor();</b>
<b class="nc">&nbsp;            List&lt;ImageView&gt; allPions = Arrays.asList(red, blue, purple, green);</b>
<b class="nc">&nbsp;            int score = player.getScore();</b>
&nbsp;            Image img;
&nbsp;
<b class="nc">&nbsp;            if (Objects.equals(color, &quot;red&quot;)) {</b>
<b class="nc">&nbsp;                if(red == null) {</b>
<b class="nc">&nbsp;                    img = new Image(Objects.requireNonNull(getClass().getResourceAsStream(&quot;/Images/Pions/CODEX_pion_rouge.png&quot;)));</b>
<b class="nc">&nbsp;                    red = new ImageView(img);</b>
&nbsp;                }
<b class="nc">&nbsp;                setPionPosition(red, score, allPions);</b>
<b class="nc">&nbsp;            } else if (Objects.equals(color, &quot;blue&quot;) ){</b>
<b class="nc">&nbsp;                if(blue == null) {</b>
<b class="nc">&nbsp;                    img = new Image(Objects.requireNonNull(getClass().getResourceAsStream(&quot;/Images/Pions/CODEX_pion_bleu.png&quot;)));</b>
<b class="nc">&nbsp;                    blue = new ImageView(img);</b>
&nbsp;                }
<b class="nc">&nbsp;                setPionPosition(blue, score, allPions);</b>
<b class="nc">&nbsp;            } else if (Objects.equals(color, &quot;purple&quot;)) {</b>
<b class="nc">&nbsp;                if(purple == null) {</b>
<b class="nc">&nbsp;                    img = new Image(Objects.requireNonNull(getClass().getResourceAsStream(&quot;/Images/Pions/CODEX_pion_purple.png&quot;)));</b>
<b class="nc">&nbsp;                    purple = new ImageView(img);</b>
&nbsp;                }
<b class="nc">&nbsp;                setPionPosition(purple, score, allPions);</b>
<b class="nc">&nbsp;            } else if (Objects.equals(color, &quot;green&quot;)) {</b>
<b class="nc">&nbsp;                if(green == null) {</b>
<b class="nc">&nbsp;                    img = new Image(Objects.requireNonNull(getClass().getResourceAsStream(&quot;/Images/Pions/CODEX_pion_vert.png&quot;)));</b>
<b class="nc">&nbsp;                    green = new ImageView(img);</b>
&nbsp;                }
<b class="nc">&nbsp;                setPionPosition(green, score, allPions);</b>
&nbsp;            }
&nbsp;        });
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Sets the pion position based on score
&nbsp;     *
&nbsp;     * @param pion     the pion to set the position
&nbsp;     * @param score    the score of the player
&nbsp;     * @param allPions the list of all pions
&nbsp;     */
&nbsp;    private void setPionPosition(ImageView pion, int score, List&lt;ImageView&gt; allPions) {
<b class="nc">&nbsp;        if (pion != null &amp;&amp; !mainPane.getChildren().contains(pion)) {</b>
<b class="nc">&nbsp;            double[] adjustedPosition = getAdjustedPosition(allPions, positions[score][0], positions[score][1], pion);</b>
<b class="nc">&nbsp;            pion.setLayoutX(adjustedPosition[0]);</b>
<b class="nc">&nbsp;            pion.setLayoutY(adjustedPosition[1]);</b>
<b class="nc">&nbsp;            pion.setFitHeight(49);</b>
<b class="nc">&nbsp;            pion.setFitWidth(49);</b>
<b class="nc">&nbsp;            pion.setPreserveRatio(true);</b>
<b class="nc">&nbsp;            updatePionsPositions(allPions, score);</b>
<b class="nc">&nbsp;            mainPane.getChildren().add(pion);</b>
<b class="nc">&nbsp;        } else if (pion != null &amp;&amp; !isPionAtDesiredPosition(pion, score)) {</b>
<b class="nc">&nbsp;            if (myself.getNickname().equals(currentPlayerNickname))</b>
<b class="nc">&nbsp;                playSoundEffect(&quot;/Audio/points.mp3&quot;);</b>
<b class="nc">&nbsp;            addPoints(pion, score, allPions);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Move the pion to the desired position based on his score
&nbsp;     *
&nbsp;     * @param pion     the pion to add points to
&nbsp;     * @param score    the score of the player
&nbsp;     * @param allPions the list of all pions
&nbsp;     */
&nbsp;    private void addPoints(ImageView pion, int score, List&lt;ImageView&gt; allPions) {
<b class="nc">&nbsp;        Platform.runLater(() -&gt; {</b>
<b class="nc">&nbsp;            if (score &lt; 0 || score &gt; 29) {</b>
&nbsp;                return;  // Invalid score
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            double startX = pion.getLayoutX();</b>
<b class="nc">&nbsp;            double startY = pion.getLayoutY();</b>
<b class="nc">&nbsp;            int start = getScoreByPosition(startX, startY) + 1;</b>
&nbsp;
<b class="nc">&nbsp;            Utilities.fadeOutTransition(mainPane, pion, 1, false);</b>
<b class="nc">&nbsp;            double[] startPositions = getAdjustedPosition(allPions, positions[start][0], positions[start][1], pion);</b>
<b class="nc">&nbsp;            pion.setLayoutY(startPositions[1]);</b>
<b class="nc">&nbsp;            pion.setLayoutX(startPositions[0]);</b>
<b class="nc">&nbsp;            pion.toFront();</b>
<b class="nc">&nbsp;            Utilities.fadeInTransition(pion, 1);</b>
<b class="nc">&nbsp;            updatePionsPositions(allPions, start);</b>
&nbsp;
<b class="nc">&nbsp;            PauseTransition pause = new PauseTransition(Duration.seconds(1));</b>
&nbsp;
<b class="nc">&nbsp;            Timeline timeline = new Timeline();</b>
&nbsp;
<b class="nc">&nbsp;            if(start == score) {</b>
&nbsp;                return;
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            for (int i = start; i &lt;= score; i++) {</b>
<b class="nc">&nbsp;                double[] adjustedPosition = getAdjustedPosition(allPions, positions[i][0], positions[i][1], pion);</b>
&nbsp;
<b class="nc">&nbsp;                KeyFrame keyFrame = new KeyFrame(Duration.millis((i - start) * 800), e -&gt; {</b>
<b class="nc">&nbsp;                    pion.setLayoutX(adjustedPosition[0]);</b>
<b class="nc">&nbsp;                    pion.setLayoutY(adjustedPosition[1]);</b>
<b class="nc">&nbsp;                    pion.toFront();</b>
&nbsp;                });
&nbsp;
<b class="nc">&nbsp;                timeline.getKeyFrames().add(keyFrame);</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            pause.setOnFinished(event -&gt; timeline.play());</b>
<b class="nc">&nbsp;            timeline.setOnFinished(event -&gt; updatePionsPositions(allPions, start)); // Ensure positions are updated after animation</b>
<b class="nc">&nbsp;            pause.play();</b>
&nbsp;        });
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Get the adjusted position of the pion, if in his desired position there is already a pion
&nbsp;     *
&nbsp;     * @param pions   the list of all pions
&nbsp;     * @param targetX the x position of the pion
&nbsp;     * @param targetY the y position of the pion
&nbsp;     * @return the adjusted position of the pion
&nbsp;     */
&nbsp;    private double[] getAdjustedPosition(List&lt;ImageView&gt; pions, double targetX, double targetY, ImageView myPion) {
<b class="nc">&nbsp;        double[] adjustedPosition = {targetX, targetY};</b>
&nbsp;
<b class="nc">&nbsp;        List&lt;ImageView&gt; sameXNonMyPions = pions.stream()</b>
<b class="nc">&nbsp;                .filter(pion -&gt; pion != myPion)</b>
<b class="nc">&nbsp;                .filter(pion -&gt; pion.getLayoutX() == targetX)</b>
<b class="nc">&nbsp;                .sorted(Comparator.comparingDouble(ImageView::getLayoutY))</b>
<b class="nc">&nbsp;                .toList();</b>
&nbsp;
<b class="nc">&nbsp;        for (ImageView pion : sameXNonMyPions) {</b>
<b class="nc">&nbsp;            if (pion.getLayoutY() == adjustedPosition[1]) {</b>
<b class="nc">&nbsp;                adjustedPosition[1] -= offsetPions;</b>
&nbsp;            } else {
&nbsp;                break;
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return adjustedPosition;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Check if the pion is at the desired position
&nbsp;     *
&nbsp;     * @param pion  the pion to check
&nbsp;     * @param score the score of the player
&nbsp;     * @return true if the pion is at the desired position, false otherwise
&nbsp;     */
&nbsp;    private boolean isPionAtDesiredPosition(ImageView pion, int score) {
<b class="nc">&nbsp;        double[] desiredPosition = positions[score];</b>
<b class="nc">&nbsp;        return (pion.getLayoutX() == desiredPosition[0] &amp;&amp; pion.getLayoutY() == desiredPosition[1]) //Starting from base position, go upwards</b>
<b class="nc">&nbsp;                || (pion.getLayoutX() == desiredPosition[0] &amp;&amp; pion.getLayoutY() == desiredPosition[1] - offsetPions)</b>
<b class="nc">&nbsp;                || (pion.getLayoutX() == desiredPosition[0] &amp;&amp; pion.getLayoutY() == desiredPosition[1] - 2 * offsetPions)</b>
<b class="nc">&nbsp;                || (pion.getLayoutX() == desiredPosition[0] &amp;&amp; pion.getLayoutY() == desiredPosition[1] - 3 * offsetPions);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Update the pions positions if a pion moved
&nbsp;     *
&nbsp;     * @param allPions  the list of all pions
&nbsp;     * @param start position
&nbsp;     */
&nbsp;    private void updatePionsPositions(List&lt;ImageView&gt; allPions, int start) {
&nbsp;
<b class="nc">&nbsp;        List&lt;ImageView&gt; nonNullSameXPions = allPions.stream()</b>
<b class="nc">&nbsp;                .filter(Objects::nonNull)</b>
<b class="nc">&nbsp;                .filter(pion -&gt; pion.getLayoutX() == positions[start][0])</b>
<b class="nc">&nbsp;                .sorted(Comparator.comparingDouble(ImageView::getLayoutY)) //Ordered by position (from bottom to top)</b>
<b class="nc">&nbsp;                .toList();</b>
&nbsp;
<b class="nc">&nbsp;        for (ImageView pion : nonNullSameXPions) {</b>
<b class="nc">&nbsp;            int score = getScoreByPosition(pion.getLayoutX(), pion.getLayoutY());</b>
<b class="nc">&nbsp;            double[] adjustedPosition = getAdjustedPosition(allPions, positions[score][0], positions[score][1], pion);</b>
<b class="nc">&nbsp;            pion.setLayoutX(adjustedPosition[0]);</b>
<b class="nc">&nbsp;            pion.setLayoutY(adjustedPosition[1]);</b>
<b class="nc">&nbsp;            pion.toFront();</b>
&nbsp;        }
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Gets the score based on the position.
&nbsp;     *
&nbsp;     * @param x the x position
&nbsp;     * @param y the y position
&nbsp;     */
&nbsp;    private int getScoreByPosition(double x, double y) {
<b class="nc">&nbsp;        for (int score = 0; score &lt; positions.length; score++) {</b>
<b class="nc">&nbsp;            double[] position = positions[score];</b>
<b class="nc">&nbsp;            if ((position[0] == x &amp;&amp; position[1] == y) //Starting from up position, check downwards</b>
&nbsp;                    || (position[0] == x &amp;&amp; position[1] == y + offsetPions)
&nbsp;                    || (position[0] == x &amp;&amp; position[1] == y + 2 * offsetPions)
&nbsp;                    || (position[0] == x &amp;&amp; position[1] == y + 3 * offsetPions)) {
<b class="nc">&nbsp;                return score;</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return -1; // Not found</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Displays the player area
&nbsp;     *
&nbsp;     * @param playerArea the player area to display
&nbsp;     */
&nbsp;    private void displayPlayerArea(PlayerArea playerArea) {
<b class="nc">&nbsp;        Platform.runLater(() -&gt; {</b>
<b class="nc">&nbsp;            ArrayList&lt;PlaceableCard&gt; newCards = playerArea.getAllCards();</b>
<b class="nc">&nbsp;            List&lt;Node&gt; currentNodes = new ArrayList&lt;&gt;(playground.getChildren());</b>
&nbsp;
<b class="nc">&nbsp;            boolean needsUpdate = false;</b>
<b class="nc">&nbsp;            int countCard = 0;</b>
&nbsp;
<b class="nc">&nbsp;            for (Node node : currentNodes)</b>
<b class="nc">&nbsp;                if (node instanceof ImageView)</b>
<b class="nc">&nbsp;                    countCard++;</b>
&nbsp;
<b class="nc">&nbsp;            if (newCards.size() != countCard) {</b>
<b class="nc">&nbsp;                needsUpdate = true;</b>
<b class="nc">&nbsp;            } else if (countCard &gt; 0) {</b>
<b class="nc">&nbsp;                for (Node node : currentNodes) {</b>
<b class="nc">&nbsp;                    if (node instanceof ImageView imageView) {</b>
<b class="nc">&nbsp;                        PlaceableCard card = (PlaceableCard) imageView.getUserData();</b>
<b class="nc">&nbsp;                        if (card != null) {</b>
<b class="nc">&nbsp;                            boolean foundMatchingCard = false;</b>
<b class="nc">&nbsp;                            for (PlaceableCard newCard : newCards) {</b>
<b class="nc">&nbsp;                                if (card.getID() == newCard.getID()) {</b>
<b class="nc">&nbsp;                                    foundMatchingCard = true;</b>
&nbsp;                                    break; // Exit inner loop if match is found
&nbsp;                                }
&nbsp;                            }
<b class="nc">&nbsp;                            if (!foundMatchingCard) {</b>
<b class="nc">&nbsp;                                needsUpdate = true;</b>
&nbsp;                                break; // Exit outer loop if update
&nbsp;                            }
&nbsp;                        } else {
<b class="nc">&nbsp;                            needsUpdate = true; //ImageView.getUserData() is null</b>
&nbsp;                            break;
&nbsp;                        }
&nbsp;                    }
&nbsp;                }
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            if (needsUpdate) {</b>
<b class="nc">&nbsp;                playground.getChildren().clear();</b>
&nbsp;
<b class="nc">&nbsp;                ArrayList&lt;ImageView&gt; cardImageViews = new ArrayList&lt;&gt;();</b>
&nbsp;
<b class="nc">&nbsp;                for (PlaceableCard card : newCards) {</b>
<b class="nc">&nbsp;                    ImageView cardImageView = Utilities.createCardImageView(</b>
<b class="nc">&nbsp;                            card.getID(), card.isFront(), card,</b>
<b class="nc">&nbsp;                            card.getCells().getFirst().getColumn() * offsetAreaX,</b>
<b class="nc">&nbsp;                            card.getCells().getFirst().getRow() * offsetAreaY,</b>
&nbsp;                            fitHeightPlaced, fitWidthPlaced
&nbsp;                    );
&nbsp;
<b class="nc">&nbsp;                    cardImageViews.add(cardImageView);</b>
<b class="nc">&nbsp;                    Utilities.fadeInTransition(cardImageView, 1.0);</b>
&nbsp;                }
&nbsp;
<b class="nc">&nbsp;                playground.getChildren().addAll(cardImageViews);</b>
&nbsp;
&nbsp;                // Adjust z-order of the cards
<b class="nc">&nbsp;                for (ImageView cardImageView : cardImageViews) {</b>
<b class="nc">&nbsp;                    PlaceableCard card = getCardFromImageView(cardImageView, newCards);</b>
<b class="nc">&nbsp;                    if (card instanceof StarterCard)</b>
<b class="nc">&nbsp;                        adjustCardZOrder(cardImageView, new ArrayList&lt;&gt;());</b>
&nbsp;                }
&nbsp;
&nbsp;                // Adjust size and position to fit
<b class="nc">&nbsp;                adjustSizeAndPosition(playground, cardImageViews);</b>
&nbsp;
<b class="nc">&nbsp;                Utilities.fadeInTransition(playground, 1.0);</b>
&nbsp;            }
&nbsp;        });
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Displays the player area and placeholders for placing cards
&nbsp;     *
&nbsp;     * @param playerArea the player area to display
&nbsp;     */
&nbsp;    private void displayPlayerAreaAndPlaceholders(PlayerArea playerArea) {
<b class="nc">&nbsp;        Platform.runLater(() -&gt; {</b>
<b class="nc">&nbsp;            ArrayList&lt;PlaceableCard&gt; newCards = playerArea.getAllCards();</b>
&nbsp;
<b class="nc">&nbsp;            playground.getChildren().clear();</b>
&nbsp;
<b class="nc">&nbsp;            ArrayList&lt;ImageView&gt; cardImageViews = new ArrayList&lt;&gt;();</b>
&nbsp;
<b class="nc">&nbsp;            for (PlaceableCard card : newCards) {</b>
<b class="nc">&nbsp;                ImageView cardImageView = Utilities.createCardImageView(</b>
<b class="nc">&nbsp;                        card.getID(), card.isFront(), card,</b>
<b class="nc">&nbsp;                        card.getCells().getFirst().getColumn() * offsetAreaX,</b>
<b class="nc">&nbsp;                        card.getCells().getFirst().getRow() * offsetAreaY,</b>
&nbsp;                        fitHeightPlaced, fitWidthPlaced
&nbsp;                );
&nbsp;
<b class="nc">&nbsp;                cardImageViews.add(cardImageView);</b>
<b class="nc">&nbsp;                Utilities.fadeInTransition(cardImageView, 1.0);</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            ArrayList&lt;ImageView&gt; placeholderImageViews = new ArrayList&lt;&gt;();</b>
&nbsp;
<b class="nc">&nbsp;            ArrayList&lt;Integer[]&gt; availablePositions = playerArea.getAvailablePosition();</b>
<b class="nc">&nbsp;            for (Integer[] pos : availablePositions) {</b>
<b class="nc">&nbsp;                double layoutX = pos[1] * offsetAreaX;  // Inverted x and y</b>
<b class="nc">&nbsp;                double layoutY = pos[0] * offsetAreaY;</b>
<b class="nc">&nbsp;                ImageView placeholderImageView = createPlaceholderImageView(</b>
&nbsp;                        layoutX, layoutY,
<b class="nc">&nbsp;                        this::confirmPlaceCard, pos[0], pos[1]</b>
&nbsp;                );
<b class="nc">&nbsp;                placeholderImageViews.add(placeholderImageView);</b>
<b class="nc">&nbsp;                Utilities.fadeInTransition(placeholderImageView, 0.5);</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            ArrayList&lt;ImageView&gt; allImageViews = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;            allImageViews.addAll(placeholderImageViews);</b>
<b class="nc">&nbsp;            allImageViews.addAll(cardImageViews);</b>
&nbsp;
<b class="nc">&nbsp;            playground.getChildren().addAll(allImageViews);</b>
&nbsp;
<b class="nc">&nbsp;            for (ImageView cardImageView : cardImageViews) {</b>
<b class="nc">&nbsp;                PlaceableCard card = getCardFromImageView(cardImageView, newCards);</b>
<b class="nc">&nbsp;                if (card instanceof StarterCard)</b>
<b class="nc">&nbsp;                    adjustCardZOrder(cardImageView, new ArrayList&lt;&gt;());</b>
&nbsp;
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            adjustSizeAndPosition(playground, allImageViews);</b>
<b class="nc">&nbsp;            Utilities.fadeInTransition(playground, 1.0);</b>
&nbsp;        });
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Adjusts the z-order of the card based on its position relative to other cards
&nbsp;     *
&nbsp;     * @param starterImage the card image view
&nbsp;     */
&nbsp;    private void adjustCardZOrder(ImageView starterImage, ArrayList&lt;ImageView&gt; nextLevelCards) {
<b class="nc">&nbsp;        if (starterImage == null)</b>
&nbsp;            return;
<b class="nc">&nbsp;        if (nextLevelCards.isEmpty()) {</b>
<b class="nc">&nbsp;            starterImage.toFront();</b>
&nbsp;
<b class="nc">&nbsp;            StarterCard starterCard = (StarterCard) starterImage.getUserData();</b>
&nbsp;
<b class="nc">&nbsp;            ArrayList&lt;ImageView&gt; newNextLevelCard = starterCard.getCells().stream()</b>
<b class="nc">&nbsp;                    .filter(cell -&gt; cell.getTopCard() != null &amp;&amp; cell.getTopCard() != starterCard)</b>
<b class="nc">&nbsp;                    .map(Cell::getTopCard)</b>
<b class="nc">&nbsp;                    .map(card -&gt; (ImageView) playground.getChildren().stream()</b>
<b class="nc">&nbsp;                            .filter(node -&gt; node instanceof ImageView)</b>
<b class="nc">&nbsp;                            .filter(node -&gt; node.getUserData() == card)</b>
<b class="nc">&nbsp;                            .findFirst().orElse(null))</b>
<b class="nc">&nbsp;                    .collect(Collectors.toCollection(ArrayList::new));</b>
<b class="nc">&nbsp;            if (newNextLevelCard.isEmpty())</b>
&nbsp;                return;
<b class="nc">&nbsp;            adjustCardZOrder(starterImage, newNextLevelCard);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            for (ImageView nextLevelCard : nextLevelCards)</b>
<b class="nc">&nbsp;                nextLevelCard.toFront();</b>
&nbsp;
<b class="nc">&nbsp;            ArrayList&lt;ImageView&gt; newNextLevelCard = nextLevelCards.stream()</b>
<b class="nc">&nbsp;                    .map(card -&gt; (PlaceableCard) card.getUserData())</b>
<b class="nc">&nbsp;                    .flatMap(card -&gt; card.getCells().stream()</b>
<b class="nc">&nbsp;                            .filter(cell -&gt; cell.getTopCard() != null &amp;&amp; cell.getTopCard() != card))</b>
<b class="nc">&nbsp;                    .map(Cell::getTopCard)</b>
<b class="nc">&nbsp;                    .map(card -&gt; (ImageView) playground.getChildren().stream()</b>
<b class="nc">&nbsp;                            .filter(node -&gt; node instanceof ImageView)</b>
<b class="nc">&nbsp;                            .filter(node -&gt; node.getUserData() == card)</b>
<b class="nc">&nbsp;                            .findFirst().orElse(null))</b>
<b class="nc">&nbsp;                    .collect(Collectors.toCollection(ArrayList::new));</b>
&nbsp;
<b class="nc">&nbsp;            if (newNextLevelCard.isEmpty())</b>
&nbsp;                return;
&nbsp;
<b class="nc">&nbsp;            adjustCardZOrder(starterImage, newNextLevelCard);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Get the PlaceableCard associated with a given ImageView
&nbsp;     *
&nbsp;     * @param imageView the ImageView
&nbsp;     * @param cards     list of all PlaceableCards
&nbsp;     * @return the PlaceableCard associated with the ImageView
&nbsp;     */
&nbsp;    private PlaceableCard getCardFromImageView(ImageView imageView, List&lt;PlaceableCard&gt; cards) {
<b class="nc">&nbsp;        PlaceableCard cardImage = (PlaceableCard) imageView.getUserData();</b>
<b class="nc">&nbsp;        if (cardImage != null) {</b>
<b class="nc">&nbsp;            for (PlaceableCard card : cards) {</b>
<b class="nc">&nbsp;                if (card.getID() == cardImage.getID()) {</b>
<b class="nc">&nbsp;                    return card;</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return null;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Creates an ImageView for a placeholder at the specified position
&nbsp;     *
&nbsp;     * @param layoutX        the x position of the placeholder
&nbsp;     * @param layoutY        the y position of the placeholder
&nbsp;     * @param eventHandler   the event handler to call when the placeholder is clicked
&nbsp;     * @param originalRow    the original row of the placeholder
&nbsp;     * @param originalColumn the original column of the placeholder
&nbsp;     * @return the ImageView for the placeholder
&nbsp;     */
&nbsp;    private ImageView createPlaceholderImageView(double layoutX, double layoutY, EventHandler&lt;MouseEvent&gt; eventHandler, int originalRow, int originalColumn) {
<b class="nc">&nbsp;        Image image = Utilities.randomColorForPlaceholder();</b>
&nbsp;
<b class="nc">&nbsp;        ImageView imageView = new ImageView(image);</b>
<b class="nc">&nbsp;        imageView.setLayoutX(layoutX);</b>
<b class="nc">&nbsp;        imageView.setLayoutY(layoutY);</b>
<b class="nc">&nbsp;        imageView.setFitHeight(133.0);</b>
<b class="nc">&nbsp;        imageView.setFitWidth(200.0);</b>
<b class="nc">&nbsp;        imageView.setOpacity(0.5);</b>
&nbsp;
&nbsp;        // Store the original row and column in the ImageView properties
<b class="nc">&nbsp;        imageView.getProperties().put(&quot;originalRow&quot;, originalRow);</b>
<b class="nc">&nbsp;        imageView.getProperties().put(&quot;originalColumn&quot;, originalColumn);</b>
&nbsp;
<b class="nc">&nbsp;        imageView.setOnMouseClicked(eventHandler);</b>
&nbsp;
<b class="nc">&nbsp;        return imageView;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Adjusts the size and position of all image views to fit within the playground
&nbsp;     *
&nbsp;     * @param playground the playground pane
&nbsp;     * @param imageViews the list of image views
&nbsp;     */
&nbsp;    private void adjustSizeAndPosition(Pane playground, ArrayList&lt;ImageView&gt; imageViews) {
&nbsp;        // Calculate bounding box of all elements
<b class="nc">&nbsp;        double minX = Double.MAX_VALUE, minY = Double.MAX_VALUE, maxX = Double.MIN_VALUE, maxY = Double.MIN_VALUE;</b>
&nbsp;
<b class="nc">&nbsp;        for (ImageView imageView : imageViews) {</b>
<b class="nc">&nbsp;            minX = Math.min(minX, imageView.getLayoutX());</b>
<b class="nc">&nbsp;            minY = Math.min(minY, imageView.getLayoutY());</b>
<b class="nc">&nbsp;            maxX = Math.max(maxX, imageView.getLayoutX() + imageView.getFitWidth());</b>
<b class="nc">&nbsp;            maxY = Math.max(maxY, imageView.getLayoutY() + imageView.getFitHeight());</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        double scaleX = playground.getWidth() / (maxX - minX);</b>
<b class="nc">&nbsp;        double scaleY = playground.getHeight() / (maxY - minY);</b>
<b class="nc">&nbsp;        double scale = Math.min(scaleX, scaleY);</b>
<b class="nc">&nbsp;        if (scale &gt; 1.0) scale = 1.0; //No scale up!</b>
&nbsp;
<b class="nc">&nbsp;        for (ImageView imageView : imageViews) {</b>
<b class="nc">&nbsp;            imageView.setScaleX(scale);</b>
<b class="nc">&nbsp;            imageView.setScaleY(scale);</b>
<b class="nc">&nbsp;            imageView.setLayoutX((imageView.getLayoutX() - minX) * scale + (playground.getWidth() - (maxX - minX) * scale) / 2);</b>
<b class="nc">&nbsp;            imageView.setLayoutY((imageView.getLayoutY() - minY) * scale + (playground.getHeight() - (maxY - minY) * scale) / 2);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Displays the online players
&nbsp;     */
&nbsp;    @FXML
&nbsp;    private void openOnline() {
<b class="nc">&nbsp;        if (!online.isVisible()) {</b>
<b class="nc">&nbsp;            online.setVisible(true);</b>
<b class="nc">&nbsp;            ArrayList&lt;String&gt; onlinePLayers = currentStateMessageSaved.getOnlinePlayers();</b>
<b class="nc">&nbsp;            Platform.runLater(() -&gt; {</b>
<b class="nc">&nbsp;                for (int i = 0; i &lt; onlinePLayers.size(); i++) {</b>
<b class="nc">&nbsp;                    if (i == 0) {</b>
<b class="nc">&nbsp;                        player1.setText(onlinePLayers.get(i));</b>
<b class="nc">&nbsp;                        player1.setVisible(true);</b>
<b class="nc">&nbsp;                    } else if (i == 1) {</b>
<b class="nc">&nbsp;                        player2.setText(onlinePLayers.get(i));</b>
<b class="nc">&nbsp;                        player2.setVisible(true);</b>
<b class="nc">&nbsp;                    } else if (i == 2) {</b>
<b class="nc">&nbsp;                        player3.setText(onlinePLayers.get(i));</b>
<b class="nc">&nbsp;                        player3.setVisible(true);</b>
<b class="nc">&nbsp;                    } else if (i == 3) {</b>
<b class="nc">&nbsp;                        player4.setText(onlinePLayers.get(i));</b>
<b class="nc">&nbsp;                        player4.setVisible(true);</b>
&nbsp;                    }
&nbsp;                }
&nbsp;            });
&nbsp;        } else {
<b class="nc">&nbsp;            online.setVisible(false);</b>
<b class="nc">&nbsp;            player1.setVisible(false);</b>
<b class="nc">&nbsp;            player2.setVisible(false);</b>
<b class="nc">&nbsp;            player3.setVisible(false);</b>
<b class="nc">&nbsp;            player4.setVisible(false);</b>
&nbsp;        }
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2024-06-26 22:00</div>
</div>
</body>
</html>
